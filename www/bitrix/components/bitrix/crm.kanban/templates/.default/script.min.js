if(typeof BX.CrmKanbanHelper==="undefined"){BX.CrmKanbanHelper=function(t){this._error="";this._popup_name="kanban_dialog";this._delayStack=t.DELAY_BETWEEN_LOADING||5;this._type=t.ENTITY_TYPE||"";this._ajaxPath=t.AJAX_PATH||"/bitrix/components/bitrix/crm.kanban/ajax.php";this._data=t.DATA||{};this._data.container=t.CONTAINER||document.body;this._currency=t.CURRENCY||"";this._extra=t.EXTRA||[];this._more_fields=t.MORE_FIELDS||[];this._more_fields_new=null;this._popup=null;this._entityId=0;this.settings={path_column_edit:t.PATH_COLUMN_EDIT||"/crm/configs/status/",show_activity:t.SHOW_ACTIVITY==="Y",access_config_perms:t.ACCESS_CONFIG_PERMS==="Y"};this._flushStack();BX.addCustomEvent("onPullEvent-im",BX.proxy(this._pullEventHandler,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this._pullEventHandler,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this._activityCheckHandler,this));BX.addCustomEvent("onPopupClose",BX.proxy(this._onClosePopup,this))};BX.CrmKanbanHelper.prototype={getEntityType:function(){return this._type},getKanban:function(){return this._kanban},getMoreFields:function(){if(this._more_fields_new===null){this._more_fields_new=[];for(var t=0;t<this._more_fields.length;t++){if(this._more_fields[t].new===1){this._more_fields_new.push(this._more_fields[t])}}}return this._more_fields_new},getSettings:function(t){return this.settings[t]},openActivityItems:function(t){this._entityId=t;this._showPopup("",{onAfterPopupShow:BX.proxy(this._loadActivities,this)})},moveState:function(t,e,a,n){var i=this._kanban.getColumn(a).items;var n=n||{};if(i.length>1){n.old_status_lastid=i[i.length-1].id}this._loadJSON({entity_id:t,prev_entity_id:this._kanban.prevItem(t,e),status:e,status_params:n||{},action:"status"})},loadPage:function(t,e){this._loadJSON({column:t,page:e,action:"page"})},_showPopup:function(t,e){if(true||this._popup===null){this._popup=new BX.PopupWindow(this._popup_name,BX.proxy_context,{closeIcon:false,autoHide:true,overlay:false,className:"crm-kanban-popup-plan",autoHide:true,closeByEsc:true,contentColor:"white",angle:true,offsetLeft:15,events:e})}var a='<div class="crm-kanban-user-loader-item"><div class="crm-kanban-loader"><svg class="crm-kanban-circular" viewBox="25 25 50 50"><circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/></svg></div></div>';this._popup.setContent(a);this._popup.show()},_onClosePopup:function(t,e){if(t.uniquePopupId===this._popup_name){BX.cleanNode(t.contentContainer)}},_flushStackTimeout:function(){if(this._stack.length>0){this._loadStack()}else{this._flushStack()}},_flushStack:function(){this._startStack=Date.now()/1e3;this._stack=[];if(0<this._delayStack){setTimeout(BX.proxy(this._flushStackTimeout,this),this._delayStack*1e3)}},_loadActivities:function(){var t=this;var e={entity_id:this._entityId,entity_type:this._type,action:"activities"};BX.ajax.get(this._ajaxPath,e,function(e){t._popup.setContent(e);t._popup.adjustPosition()})},_loadStack:function(){var t=this._stack;this._flushStack();this._loadJSON({entity_id:t,action:"get"})},_loadJSON:function(t){var e=this;t.entity_type=this._type;t.sessid=BX.bitrix_sessid();t.extra=this._extra;BX.ajax.loadJSON(this._ajaxPath,t,function(a){if(typeof a!=="undefined"){var n=a.error||[];var i=a.items||[];var o=a.columns||[];if(n.length>0){alert(n+"\n"+BX.message("CRM_KANBAN_RELOAD_PAGE"))}else{for(var r=0;r<i.length;r++){var s=e._kanban.getItem(i[r].id);if(!s){e._kanban.addItem(i[r])}if(typeof t.page==="undefined"&&(typeof t.status_params==="undefined"||typeof t.status_params.old_status_lastid==="undefined")){var l=e._kanban.getColumn(i[r].columnId).items;e._kanban.moveItemToColumShow(i[r].id,i[r].columnId,l.length>0?l[0].id:null,i[r].modifyByAvatar)}}e._kanban.counterTotalPrice(o)}}})},_pullEventHandler:function(t,e){if(t==="activity_add"&&e.OWNER_TYPE_NAME===this._type&&e.COMPLETED!=="Y"){BX.CrmKanbanItem.changeActCount(e.OWNER_ID,1)}if(t==="kanban_add"||t==="kanban_update"){var a=e;var n=this._kanban.getItem(a.id);var i=this._kanban.getColumn(a.columnId);var o=i.items;var r=o.length>0?o[0].id:null;var s=this._kanban.columns;var l=[];if(!n){a.columnColor=i.color;this._kanban.addItem(a,r)}else if(n.columnId===a.columnId){return}for(var c in s){var d=parseInt(s[c].count);var m=parseFloat(s[c].total);if(n&&n.columnId===c){d--;m=m-parseFloat(a.price)}else if(a.columnId===c){d++;m=m+parseFloat(a.price)}s[c].count=d;s[c].total=m;s[c].total_format=BX.Currency.currencyFormat(m,this._currency,true);l.push({id:s[c].id,price:s[c].price,columnId:c,count:d,total:m,total_format:s[c].total_format})}this._kanban.moveItemToColumShow(a.id,a.columnId,r,a.modifyByAvatar);this._kanban.counterTotalPrice(l)}},_activityCheckHandler:function(t,e,a){BX.CrmKanbanItem.changeActCount(e,-1)}};BX.CrmKanbanHelper.instance=null;BX.CrmKanbanHelper.create=function(t){if(BX.CrmKanbanHelper.instance===null){var e=new BX.CrmKanbanHelper(t);BX.CrmKanbanHelper.instance=e;e._kanban=new BX.CrmKanbanGrid(e._data);e._kanban.draw()}return BX.CrmKanbanHelper.instance};BX.CrmKanbanHelper.getInstance=function(){return BX.CrmKanbanHelper.instance}}if(typeof BX.CrmKanbanGrid==="undefined"){BX.CrmKanbanGrid=function(t){this.columns=Object.create(null);this.columns_sort={};this.items=Object.create(null);this.dropzones=Object.create(null);this.container=t.container;this.dragger=new BX.CrmKanbanDragDrop(this);this.loadData(t);this.kanban=null;this.scrollKanban()};BX.CrmKanbanGrid.prototype={scrollKanban:function(){this.kanban=kanban;var t=this.kanban.parentNode.offsetWidth;var e=this.kanban.getBoundingClientRect().top;var a=document.documentElement.clientHeight-e;var n=this.kanban.parentNode.getBoundingClientRect().top;var i=this.kanban.parentNode.getBoundingClientRect().left;var o=document.getElementById("footer");var r=o.offsetHeight;var s=o.getBoundingClientRect().top;var l=document.documentElement.clientHeight-s;var c=getComputedStyle(document.body.querySelector(".workarea-content-paddings"));var d=+c.paddingBottom.slice(0,-2);function m(){t=this.kanban.parentNode.offsetWidth;n=this.kanban.parentNode.getBoundingClientRect().top;e=this.kanban.getBoundingClientRect().top;i=this.kanban.parentNode.getBoundingClientRect().left;o=document.getElementById("footer");s=o.getBoundingClientRect().top;l=document.documentElement.clientHeight-s;this.kanban.style.position="relative";this.kanban.style.left="0";this.kanban.style.top="0";this.kanban.style.width=t+"px";this.kanban.style.height=a+"px";this.kanban.style.maxHeight=document.documentElement.clientHeight+"px";if(n<=0){this.kanban.style.position="fixed";this.kanban.style.left=i+"px";this.kanban.style.top="5px";if(s-d<=document.documentElement.clientHeight){var r=document.documentElement.clientHeight-s;this.kanban.style.height=a-r-d+"px"}}}var p=false;BX.bind(this.kanban,"mouseenter",function(){p=true});BX.bind(this.kanban,"mouseleave",function(){p=false;document.body.style.overflow="";kanban.style.width=kanban.parentNode.offsetWidth+"px"});function u(){t=this.kanban.parentNode.offsetWidth;e=this.kanban.getBoundingClientRect().top;n=this.kanban.parentNode.getBoundingClientRect().top;i=this.kanban.parentNode.getBoundingClientRect().left;a=document.documentElement.clientHeight-e;o=document.getElementById("footer");r=o.offsetHeight;s=o.getBoundingClientRect().top;l=document.documentElement.clientHeight-s;var c=Math.round(window.pageYOffset||document.documentElement.scrollTop);var m=BX.pos(this.kanban.parentNode,false);this.kanban.style.height=document.documentElement.clientHeight-e+"px";if(c<m.top){this.kanban.style.position="relative";this.kanban.style.left="0";this.kanban.style.top="0";this.kanban.style.height=a+"px";this.kanban.parentNode.style.height=document.documentElement.clientHeight+300+"px"}if(n<=0){this.kanban.style.position="fixed";this.kanban.style.width=this.kanban.parentNode.offsetWidth+"px";this.kanban.style.left=i+"px";this.kanban.style.top="5px";this.kanban.style.height=a+"px";if(p==true){document.body.style.overflow="hidden";kanban.style.width=kanban.parentNode.offsetWidth+"px"}if(p==false){document.body.style.overflow="";kanban.style.width=kanban.parentNode.offsetWidth+"px"}if(s-d<=document.documentElement.clientHeight){var u=document.documentElement.clientHeight-s;this.kanban.style.height=a-u-d+"px"}}}function h(){setTimeout(function(){var t=kanban.parentNode.offsetWidth;var e=kanban.parentNode.getBoundingClientRect().top;var a=kanban.getBoundingClientRect().top;var n=kanban.parentNode.getBoundingClientRect().left;var i=document.documentElement.clientHeight-a;var o=document.getElementById("footer");var r=o.getBoundingClientRect().top;var s=document.documentElement.clientHeight-r;var l=BX.pos(kanban.parentNode,false);kanban.style.position="relative";kanban.style.left="0";kanban.style.top="0";kanban.style.width=t+"px";kanban.style.height=i+"px";kanban.style.maxHeight=document.documentElement.clientHeight+"px";if(e<=0){kanban.style.position="fixed";kanban.style.left=n+"px";kanban.style.top="0";if(s>=0){kanban.style.height=document.documentElement.clientHeight-(s+d)+"px"}else{kanban.style.height=document.documentElement.clientHeight+"px"}}},500)}var b=document.querySelector(".bx-filter-switcher-tab");m();b.addEventListener("click",h,false);window.addEventListener("resize",m,false);window.addEventListener("scroll",u,false)},prevItem:function(t,e){var a=this.getColumn(e);if(a){var n=a.items||[];var i=n.length;if(i>1){for(var o=0;o<i-1;o++){if(n[o+1].id===t){return n[o].id}}}}return 0},counterTotalPrice:function(t){var e=this.columns;if(typeof t==="undefined"){for(var a in e){n(e[a].total,e[a].layout.summary,e[a].count,e[a].layout.total,e[a].total_format,e[a]);if(e[a].layout.items.classList.contains("crm-kanban-items-blocked")){e[a].layout.items.classList.remove("crm-kanban-items-blocked")}}}else{for(var a=0;a<t.length;a++){if(e[t[a].id]){n(t[a].total,e[t[a].id].layout.summary,t[a].count,e[t[a].id].layout.total,t[a].total_format,e[t[a].id]);if(e[t[a].id].layout.items.classList.contains("crm-kanban-items-blocked")){e[t[a].id].layout.items.classList.remove("crm-kanban-items-blocked")}}}}function n(t,e,a,n,i,o){var a=a;var n=n;var t=t;var r=e;var s;var l=r.getAttribute("data-total");var c=+l;n.innerHTML=a;if(o.items.length<+a){o.layout.items.appendChild(o.layout.loadMore);o.layout.loadMore.classList.remove("crm-kanban-loadmore-show")}if(c!==null){if(c>t){s=(c-t)/40}else{s=(t-c)/40}}else{s=t/40}if(t!=0){function d(t,e,a,n,o){t=parseInt(t);s=0;if(o!=null){var s=+o}if(s<t){(function(){if(s<=t){setTimeout(arguments.callee,a);r.innerHTML=BX.util.number_format(s,0,","," ");s=s+n}else{r.innerHTML=i;r.setAttribute("data-total",t)}})()}else if(s>t){(function(){if(s>=t){setTimeout(arguments.callee,a);r.innerHTML=BX.util.number_format(s,0,","," ");s=s-n}else{r.innerHTML=i;r.setAttribute("data-total",t)}})()}else{return false}}d(t,r,10,s,c)}else{r.setAttribute("data-total","0");r.innerHTML="0"}}},addColumn:function(t){t=t||{};if(this.getColumn(t.id)!==null){return}var e=new BX.CrmKanbanColumn(t);e.kanban=this;this.columns[t.id]=e;this.columns_sort[t.sort]=t.id},addDrop:function(t){t=t||{};if(this.getDrop(t.id)!==null){return}var e=new BX.CrmKanbanDrop(t);e.kanban=this;this.dropzones[t.id]=e},addItem:function(t){t=t||{};var e=this.getColumn(t.columnId);if(e){var a=new BX.CrmKanbanItem(t);a.kanban=this;this.items[t.id]=a;e.addItem(a)}},moveItemToColumShow:function(t,e,a,n){t=this.getItem(t);e=this.getColumn(e);a=this.getItem(a);var i=this.getColumn(t.columnId);var o=document.querySelector('[data-move="'+t.id+'"]');var r=o.offsetWidth;var s=document.querySelector('[data-move-column="'+e.id+'"]');if(a){s=document.querySelector('[data-move="'+a.id+'"]')}var l=null;var c=null;function d(t){var e=t.getBoundingClientRect();var a=document.body;var n=document.documentElement;var i=window.pageYOffset||n.scrollTop||a.scrollTop;var o=window.pageXOffset||n.scrollLeft||a.scrollLeft;var r=n.clientTop||a.clientTop||0;var s=n.clientLeft||a.clientLeft||0;l=e.top+i-r;c=e.left+o-s}d(o);o.classList.add("crm-kanban-deal-item-block");var m="crm-kanban-grid-item-pre";if(a){m="crm-kanban-deal-item-pre"}s.classList.add(m);var p=o.cloneNode(true);if(n){var u=BX.create("div",{attrs:{className:"crm-kanban-deal-item-touchuser",style:"background-image: url("+n+")"}});p.appendChild(u)}p.classList.add("crm-kanban-deal-item-dragshow");p.style.width=r+"px";p.style.position="absolute";p.style.top=l+"px";p.style.left=c+"px";p.style.zIndex="999999";document.body.appendChild(p);setTimeout(d(s),1);setTimeout(function(){p.style.top=l+102+"px";if(a){p.style.top=l+"px"}p.style.left=c+"px"},1);setTimeout(function(){if(i!==e){i.removeItem(t);e.addItem(t,a)}o.classList.remove("crm-kanban-deal-item-block");s.classList.remove(m);p.parentNode.removeChild(p)},1e3)},moveItemToColum:function(t,e,a){if(BX.type.isNumber(t)){t=this.getItem(t)}var n=t.layout.container.querySelector(".crm-kanban-deal-item-wrapper-border");var i=e.color;n.style.background="#"+i;if(BX.type.isNumber(e)){e=this.getColumn(e)}if(BX.type.isNumber(a)){a=this.getItem(a)}var o=this.getColumn(t.columnId);if(o!==e){o.removeItem(t);e.addItem(t,a)}else if(a){if(a!==t){o.removeItem(t);e.addItem(t,a)}}else if(o&&!a){o.removeItem(t);e.addItem(t,a)}},removeToColumnItem:function(t){var e=this.getColumn(t.columnId);e.removeItem(t)},getColumn:function(t){return this.columns[t]?this.columns[t]:null},getDrop:function(t){return this.dropzones[t]?this.dropzones[t]:null},getItem:function(t){return this.items[t]?this.items[t]:null},draw:function(){var t=document.createDocumentFragment();for(var e in this.columns_sort){var a=this.columns_sort[e];t.appendChild(this.columns[a].render())}var n=BX.create("div",{attrs:{className:"crm-kanban-dropzone",style:"left: "+(BX.pos(this.kanban.parentNode).left-15)+"px"}});var i=document.createDocumentFragment();for(var o in this.dropzones){i.appendChild(this.dropzones[o].render())}var r=BX.create("div",{attrs:{className:"crm-kanban-grid-wrapper"}});n.appendChild(i);r.appendChild(t);this.container.appendChild(r);document.body.appendChild(n);this.counterTotalPrice();this.setShadow()},setShadow:function(){function t(){if(kanban.firstElementChild.offsetWidth>kanban.offsetWidth){var t=kanban.scrollWidth-kanban.offsetWidth;var e=kanban.scrollLeft;if(e<=0){kanban.parentNode.className="crm-kanban crm-kanban-right"}else if(e>0&&e!==t){kanban.parentNode.className="crm-kanban crm-kanban-right crm-kanban-left"}else if(e==t){kanban.parentNode.className="crm-kanban crm-kanban-left"}}else{kanban.parentNode.className="crm-kanban"}}t();window.addEventListener("resize",t,false);this.kanban.addEventListener("scroll",t,false)},loadData:function(t){if(BX.type.isArray(t.columns)){t.columns.forEach(function(t){if(t.type==="LOOSE"){this.addDrop(t)}else{this.addColumn(t,true)}},this)}if(BX.type.isArray(t.items)){t.items.forEach(function(t){this.addItem(t)},this)}if(t.events){for(var e in t.events){if(t.events.hasOwnProperty(e)){BX.addCustomEvent(this,e,t.events[e])}}}}}}if(typeof BX.CrmKanbanDrop==="undefined"){BX.CrmKanbanDrop=function(t){this.id=t.id;this.name=t.name;this.color=t.color;this.kanban=null;this.layout={container:null}};BX.CrmKanbanDrop.prototype={render:function(){dropContainer=BX.create("div",{attrs:{className:"crm-kanban-dropzone-item","data-type":"drop","data-id":this.id},children:[BX.create("div",{attrs:{className:"crm-kanban-dropzone-item-bg",style:"background: #"+this.color}}),BX.create("div",{attrs:{className:"crm-kanban-dropzone-item-title"},html:this.name})]});this.kanban.dragger.registerDrop(dropContainer);return dropContainer}}}if(typeof BX.CrmKanbanColumn==="undefined"){BX.CrmKanbanColumn=function(t){this.id=t.id;this.name=t.name;this.color=t.color;this.sort=t.sort;this.count=t.count;this.total=t.total;this.total_format=t.total_format;this.currency=t.currency;this.items=[];this.layout={container:null,items:null,title:null,summary:null,total:null,input:null,name:null,color:null,loadMore:null,loadMoreClick:null};this.kanban=null;this.page=1;this.lastId=0};BX.CrmKanbanColumn.prototype={addItem:function(t,e){if(!t instanceof BX.CrmKanbanItem){throw"item must be an instance of BX.CrmKanbanItem"}t.columnId=this.id;this.lastId=t.id;var a=BX.util.array_search(e,this.items);if(a>=0){this.items.splice(a,0,t)}else{this.items.push(t)}if(this.layout.container){this.render()}},removeItem:function(t){this.items=this.items.filter(function(e){return e!==t});if(this.layout.container){this.render()}},setName:function(t){this.name=t},loadMoreClick:function(){this.page++;BX.CrmKanbanHelper.getInstance().loadPage(this.id,this.page);this.layout.loadMore.classList.add("crm-kanban-loadmore-show")},createLayout:function(){this.layout.loadMore=BX.create("div",{attrs:{className:"crm-kanban-loadmore"},children:[BX.create("div",{attrs:{className:"crm-kanban-user-loader"},html:'<div class="crm-kanban-user-loader-item">'+'<div class="crm-kanban-loader">'+'<svg class="crm-kanban-circular" viewBox="25 25 50 50">'+'<circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/>'+"</svg>"+"</div>"+"</div>"}),BX.create("span",{attrs:{className:"crm-kanban-loadmore-link"},text:BX.message("CRM_KANBAN_ACTIVITY_MORE"),events:{click:BX.proxy(this.loadMoreClick,this)}})]});if(this.layout.container!==null){return this.layout.container}var t="crm-kanban-header crm-kanban-header-lead";BX.CrmKanbanHelper.getInstance().getEntityType()!=="LEAD"?t="crm-kanban-header":null;var e="crm-kanban-step-title";function a(t){var a=parseInt(t,16);var n=a>>16&255;var i=a>>8&255;var o=a&255;var r=.21*n+.72*i+.07*o;if(r<145){e="crm-kanban-step-title crm-kanban-step-title-dark"}}if(this.color){a(this.color)}this.layout.container=BX.create("div",{attrs:{className:"crm-kanban-grid-item","data-id":this.id,"data-move-column":this.id,"data-type":"column"},children:[BX.create("div",{attrs:{className:t},children:[BX.create("div",{attrs:{className:e},children:[this.layout.color=BX.create("div",{attrs:{className:"crm-kanban-step-title-bg",style:"background: #"+this.color}}),this.layout.name=BX.create("span",{attrs:{className:"crm-kanban-step-title-name"}}),this.layout.total=BX.create("span",{attrs:{className:"crm-kanban-step-title-total"}}),BX.CrmKanbanHelper.getInstance().getSettings("access_config_perms")?BX.create("a",{attrs:{href:BX.CrmKanbanHelper.getInstance().getSettings("path_column_edit"),className:"crm-kanban-step-title-edit"}}):null,this.color==""?BX.create("span",{attrs:{className:"crm-kanban-step-title-right"}}):BX.create("span",{attrs:{className:"crm-kanban-step-title-right",style:"background: #fff url(data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2213%22%20height%3D%2232%22%20viewBox%3D%220%200%2013%2032%22%3E%3Cpath%20fill%3D%22%23"+this.color+"%22%20fill-opacity%3D%221%22%20d%3D%22M0%200h3c2.8%200%204%203%204%203l6%2013-6%2013s-1.06%203-4%203H0V0z%22/%3E%3C/svg%3E) no-repeat"}})]}),BX.CrmKanbanHelper.getInstance().getEntityType()!=="LEAD"?BX.create("div",{attrs:{className:"crm-kanban-total-price"},children:[this.layout.summary=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}})]}):BX.create("div",{attrs:{className:"crm-kanban-total-price crm-kanban-total-price-off"},children:[this.layout.summary=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}})]})]}),this.layout.items=BX.create("div",{attrs:{className:"crm-kanban-items","data-type":"column"}})]});this.kanban.dragger.registerColumn(this.layout.container);return this.layout.container},getSummaryPrice:function(){var t=0;this.items.forEach(function(e){t+=e.price});return t},render:function(){var t=true;var e=true;if(this.layout.container===null){this.createLayout()}this.layout.container.style.maxWidth=this.kanban.container.offsetWidth/2+"px";BX.cleanNode(this.layout.items);for(var a=0;a<this.items.length;a++){var n=this.items[a];if(this.id===n.columnId){e=false;if(n.page===n.pageCount){t=false}}this.layout.items.appendChild(n.render())}this.layout.name.innerHTML=this.name;return this.layout.container}}}if(typeof BX.CrmKanbanItem==="undefined"){BX.CrmKanbanItem=function(t){this.id=t.id;this.name=t.name;this.link=t.link;this.price=t.price;this.price_formatted=t.price_formatted;this.date=t.date;this.im=t.im;this.activityProgress=t.activityProgress;this.activityTotal=t.activityTotal;this.activityShow=t.activityShow;this.contactName=t.contactName;this.contactLink=t.contactLink;this.contactId=t.contactId;this.contactType=t.contactType;this.mail=t.email;this.phone=t.phone;this.columnId=t.columnId;this.columnColor=t.columnColor;this.page=t.page;this.pageCount=t.pageCount;this.fields=t.fields;this.layout={container:null,title:null,items:null,popup:null};this.popupTooltip=null;this.kanban=null;this.helper=BX.CrmKanbanHelper.getInstance();this.entityType=this.helper.getEntityType();this.moreFields=this.helper.getMoreFields();this.activityShow=this.helper.getSettings("show_activity")};BX.CrmKanbanItem.prototype={clickChat:function(){BXIM.openMessenger(this.im.value)},clickContact:function(t){var e=t==="mail"?this.mail:this.phone;if(e.length>1){var a=BX.findParent(BX.proxy_context,{className:"crm-kanban-deal-item"}).getAttribute("data-id");var n=[];this.layout.container.classList.add("crm-kanban-deal-item-active");document.body.addEventListener("click",BX.proxy(this.onBodyClick,this),true);for(var i=0;i<e.length;i++){if(t==="mail"){n.push({text:e[i]["value"]+" ("+e[i]["title"]+")",href:"mailto:"+e[i]["value"]})}else{n.push({phone:e[i]["value"],text:e[i]["value"]+" ("+e[i]["title"]+")",onclick:BX.proxy(this.clickPhoneCall,this)})}}BX.PopupMenu.show("kanban-contact-"+t+"-"+a,BX.proxy_context,n,{autoHide:true,zIndex:1200,offsetLeft:20,angle:true,closeByEsc:true})}else{var i=0;if(t==="mail"){}else{this.clickPhoneCall(i,{phone:e[i]["value"]})}}},onBodyClick:function(){var t=document.body.querySelector(".crm-kanban-deal-item-active");t.classList.remove("crm-kanban-deal-item-active");document.body.removeEventListener("click",BX.proxy(this.onBodyClick,this),true)},clickMail:function(){this.clickContact("mail")},clickPhone:function(){this.clickContact("phone")},clickPhoneCall:function(t,e){if(typeof BXIM!=="undefined"){BXIM.phoneTo(e.phone,{ENTITY_TYPE:this.contactType,ENTITY_ID:this.contactId})}},addField:function(){var t=BX.findParent(BX.proxy_context,{className:"crm-kanban-deal-item"}).getAttribute("data-id");var e=[];for(var a=0;a<this.moreFields.length;a++){e.push({code:this.moreFields[a]["code"],text:this.moreFields[a]["title"],onclick:BX.proxy(this.addFieldClick,this)})}BX.PopupMenu.show("kanban-more-fields-"+t,BX.proxy_context,e)},addFieldClick:function(t,e){var a=top.location.href;top.location.href=a+(a.indexOf("?")===-1?"?":"&")+"set_field="+e.code},delField:function(){var t=top.location.href;t=t+(t.indexOf("?")===-1?"?":"&")+"del_field="+BX.proxy_context.getAttribute("data-code");top.location.href=t},activityClick:function(){BX.CrmKanbanHelper.getInstance().openActivityItems(this.id)},activityPlanClick:function(){var t=BX.findParent(BX.proxy_context,{className:"crm-kanban-deal-item"}).getAttribute("data-id");var e=[{type:"call",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_CALL"),onclick:BX.proxy(this.activityPlanClickItem,this)},{type:"meeting",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_MEETING"),onclick:BX.proxy(this.activityPlanClickItem,this)},{type:"task",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_TASK"),onclick:BX.proxy(this.activityPlanClickItem,this)}];BX.PopupMenu.show("kanban-plan-"+t,BX.proxy_context,e,{autoHide:true,zIndex:-9,offsetLeft:20,angle:true,overlay:false})},activityPlanClickItem:function(t,e){if(e.type==="meeting"||e.type==="call"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType[e.type],OWNER_TYPE:this.entityType,OWNER_ID:this.id})}else if(e.type==="task"){if(typeof window["taskIFramePopup"]!=="undefined"){var a={UF_CRM_TASK:[BX.CrmOwnerTypeAbbr.resolve(this.entityType)+"_"+this.id],TITLE:"CRM: ",TAGS:"crm"};window["taskIFramePopup"].add(a)}}},renderFields:function(){var t=[];for(var e=0;e<this.fields.length;e++){t.push(BX.create("div",{attrs:{},children:[BX.create("span",{attrs:{className:"crm-kanban-deal-item-field"},html:this.fields[e]["title"]+": "+this.fields[e]["value"]}),BX.create("span",{attrs:{className:"crm-kanban-deal-item-field-del","data-code":this.fields[e]["code"]},html:"*",events:{click:BX.proxy(this.delField,this)}})]}))}return t},render:function(){if(this.layout.container===null){this.layout.container=BX.create("div",{attrs:{className:"crm-kanban-deal-item","data-id":this.id,"data-move":this.id,"data-type":"item"},children:[BX.create("div",{attrs:{className:"crm-kanban-deal-item-wrapper"},children:[BX.create("div",{attrs:{className:"crm-kanban-deal-item-wrapper-border","data-role":"item-color",style:"background: #"+this.columnColor}}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-wrapper-line"}}),BX.create("a",{attrs:{className:"crm-kanban-deal-item-title",href:this.link,title:BX.util.htmlspecialcharsback(this.name)},html:this.name}),BX.CrmKanbanHelper.getInstance().getEntityType()!=="LEAD"?BX.create("div",{attrs:{className:"crm-kanban-deal-item-total"},children:[BX.create("div",{attrs:{className:"crm-kanban-deal-item-total-price"},html:this.price_formatted})]}):null,BX.create("a",{attrs:{className:"crm-kanban-deal-item-user",href:this.contactLink},html:this.contactName}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-date"},html:this.date}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-planner"},children:[this.activityShow?BX.create("span",{attrs:{className:"crm-kanban-deal-item-activity",id:"crm-kanban-act-count-"+this.id,"data-count":this.activityProgress,style:this.activityProgress>0?"display: block":"display: none;"},text:BX.message("CRM_KANBAN_ACTIVITY_PLAN")+": "+this.activityProgress,events:{click:BX.proxy(this.activityClick,this)}}):null,this.activityShow?BX.create("div",{attrs:{className:"crm-kanban-deal-item-activity-empty",id:"crm-kanban-act-icon-"+this.id,style:this.activityProgress>0?"display: none":"display: block;"},events:{mouseover:function(){this.popupTooltip=new BX.PopupWindow("kanban_plan_tooltip",this,{offsetLeft:8,darkMode:true,closeByEsc:true,angle:true,autoHide:true,content:BX.message("CRM_KANBAN_ACTIVITY_LETSGO")});this.popupTooltip.show()},mouseout:function(){var t=this.popupTooltip;setTimeout(function(){t.destroy()},500)}}}):null,this.activityShow?BX.create("span",{attrs:{className:"crm-kanban-deal-item-plan"},text:BX.message("CRM_KANBAN_ACTIVITY_MY"),events:{click:BX.proxy(this.activityPlanClick,this)}}):null]}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-contact"},children:[BX.create("a",{attrs:{className:this.phone?"crm-kanban-step-contact-phone":"crm-kanban-step-contact-phone crm-kanban-step-contact-phone-disabled",href:"javascript:void(0)"},events:{click:BX.proxy(this.clickPhone,this)}}),BX.create("a",{attrs:{className:this.mail?"crm-kanban-step-contact-mail":"crm-kanban-step-contact-mail crm-kanban-step-contact-mail-disabled",href:!this.mail||this.mail.length>1?"javascript:void(0)":"mailto:"+this.mail[0]["value"]},events:{click:BX.proxy(this.clickMail,this)}}),BX.create("span",{attrs:{className:this.im?"crm-kanban-step-contact-message":"crm-kanban-step-contact-message crm-kanban-step-contact-message-disabled"},events:{click:BX.proxy(this.clickChat,this)}})]})]})]});this.kanban.dragger.registerItem(this.layout.container)}return this.layout.container}};BX.CrmKanbanItem.changeActCount=function(t,e){var a=Math.max(0,parseInt(BX.data(BX("crm-kanban-act-count-"+t),"count"))+parseInt(e)*1);BX.data(BX("crm-kanban-act-count-"+t),"count",a);BX("crm-kanban-act-count-"+t).innerText=BX.message("CRM_KANBAN_ACTIVITY_PLAN")+": "+a;if(a>0){BX.show(BX("crm-kanban-act-count-"+t));BX.hide(BX("crm-kanban-act-icon-"+t))}else{BX.hide(BX("crm-kanban-act-count-"+t));BX.show(BX("crm-kanban-act-icon-"+t))}}}if(typeof BX.CrmKanbanDragDrop==="undefined"){BX.CrmKanbanDragDrop=function(t){this.kanban=t;this.draggableItem=null;this.droppableColumn=null;this.stub=null;this.droppableZone=null;this.dropContainer=null};BX.CrmKanbanDragDrop.prototype.registerItem=function(t){t.onbxdragstart=BX.proxy(this.onDragStart,this);t.onbxdrag=BX.proxy(this.onDrag,this);t.onbxdragstop=BX.proxy(this.onDragStop,this);t.onbxdraghover=BX.proxy(this.onDragOver,this);jsDD.registerObject(t);jsDD.registerDest(t,10)};BX.CrmKanbanDragDrop.prototype.registerDrop=function(t){jsDD.registerDest(t,1)};BX.CrmKanbanDragDrop.prototype.registerColumn=function(t){jsDD.registerDest(t,20)};BX.CrmKanbanDragDrop.prototype.onDragStart=function(){this.kanban.container.style.overflow="hidden";this.dropContainer=document.querySelector(".crm-kanban-dropzone");this.dropContainer.className="crm-kanban-dropzone crm-kanban-dropzone-show";this.dropContainer.style.position="fixed";this.dropContainer.style.left=BX.pos(this.kanban.container).left-15+"px";this.dropContainer.style.right=63+"px";var t=BX.proxy_context;var e=BX.type.isDomNode(t)?t.getAttribute("data-id"):null;var a=document.documentElement.clientHeight-this.kanban.container.getBoundingClientRect().bottom;if(a>0){this.dropContainer.style.bottom=a-20+"px"}else{this.dropContainer.style.bottom=""}this.draggableItem=this.kanban.getItem(e);this.draggableItem.layout.container.classList.add("crm-kanban-deal-item-block");if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var n=this.draggableItem.layout.container.offsetWidth;this.stub=this.draggableItem.layout.container.cloneNode(true);this.stub.style.position="absolute";this.stub.style.width=n+"px";this.stub.className="crm-kanban-deal-item crm-kanban-deal-item-drag";document.body.style.height=document.documentElement.clientHeight+"px";document.body.style.overflow="hidden";document.body.appendChild(this.stub)}};BX.CrmKanbanDragDrop.prototype.onDrag=function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"};BX.CrmKanbanDragDrop.prototype.onDragOver=function(t,e,a){if(this.droppableItem){this.droppableItem.layout.container.classList.remove("crm-kanban-deal-item-pre")}if(this.droppableColumn){this.droppableColumn.layout.container.className="crm-kanban-grid-item"}if(this.droppableZone){this.droppableZone.className="crm-kanban-dropzone-item"}var n=t.getAttribute("data-id");var i=t.getAttribute("data-type");if(i==="item"){this.droppableItem=this.kanban.getItem(n);this.droppableColumn=null;this.droppableZone=null}else if(i==="column"){this.droppableColumn=this.kanban.getColumn(n);this.droppableItem=null;this.droppableZone=null}else if(i==="drop"){this.droppableZone=t;this.droppableColumn=null;this.droppableItem=null}if(this.droppableItem){this.droppableItem.layout.container.classList.add("crm-kanban-deal-item-pre")}if(this.droppableZone){this.droppableZone.className="crm-kanban-dropzone-item crm-kanban-dropzone-item-pre"}if(this.droppableColumn){var o="crm-kanban-grid-item-pre";if(this.droppableColumn.layout.loadMore.parentNode==null){o="crm-kanban-grid-item-column-pre"}this.droppableColumn.layout.container.classList.add(o)}};BX.CrmKanbanDragDrop.prototype.invoicePopupInstance=null;BX.CrmKanbanDragDrop.prototype.invoicePopup=function(t,e,a){if(this.invoicePopupInstance===null){this.invoicePopupInstance=new BX.PopupWindow("kanban_invoice",window.body,{offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",content:BX.create("div",{attrs:{className:"crm-kanban-popup-wrapper"},children:[BX.create("table",{attrs:{className:"crm-kanban-popup-table"},children:[BX.create("tr",{children:[BX.create("td",{children:[BX.create("SPAN",{attrs:{className:"crm-kanban-popup-text"},text:BX.message("CRM_KANBAN_INVOICE_PARAMS_DATE")})]}),BX.create("td",{children:[BX.create("INPUT",{attrs:{id:"crm-kanban-droppopup-date",className:"crm-kanban-popup-input"},events:{click:function(){BX.calendar({node:this,field:this})}}})]})]}),BX.create("tr",{attrs:{id:"crm-kanban-droppopup-winblock"
},children:[BX.create("td",{children:[BX.create("SPAN",{attrs:{className:"crm-kanban-popup-text"},text:BX.message("CRM_KANBAN_INVOICE_PARAMS_DOCNUM")})]}),BX.create("td",{children:[BX.create("INPUT",{attrs:{id:"crm-kanban-droppopup-docnum",className:"crm-kanban-popup-input"}})]})]}),BX.create("tr",{children:[BX.create("td",{attrs:{colspan:"2",className:"crm-kanban-popup-border"},children:[BX.create("SPAN",{attrs:{className:"crm-kanban-popup-text"},text:BX.message("CRM_KANBAN_INVOICE_PARAMS_COMMENT")}),BX.create("TEXTAREA",{attrs:{id:"crm-kanban-droppopup-comment",className:"crm-kanban-popup-textarea"}}),BX.create("INPUT",{attrs:{type:"hidden",id:"crm-kanban-droppopup-id"}}),BX.create("INPUT",{attrs:{type:"hidden",id:"crm-kanban-droppopup-status"}}),BX.create("INPUT",{attrs:{type:"hidden",id:"crm-kanban-droppopup-oldstatus"}})]})]})]})]}),buttons:[new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_INVOICE_PARAMS_SAVE"),className:"popup-window-button-accept",events:{click:function(){BX.CrmKanbanHelper.getInstance().moveState(BX("crm-kanban-droppopup-id").value,BX("crm-kanban-droppopup-status").value,BX("crm-kanban-droppopup-oldstatus").value,{comment:BX("crm-kanban-droppopup-comment").value,date:BX("crm-kanban-droppopup-date").value,docnum:BX("crm-kanban-droppopup-docnum").value});this.popupWindow.close()}}})]});this.invoicePopupInstance.setTitleBar(BX.message("CRM_KANBAN_INVOICE_PARAMS"))}BX("crm-kanban-droppopup-comment").value="";BX("crm-kanban-droppopup-date").value=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")));BX("crm-kanban-droppopup-docnum").value="";BX("crm-kanban-droppopup-id").value=t;BX("crm-kanban-droppopup-status").value=e;BX("crm-kanban-droppopup-oldstatus").value=a;if(e==="P"){BX.show(BX("crm-kanban-droppopup-winblock"))}else{BX.hide(BX("crm-kanban-droppopup-winblock"))}this.invoicePopupInstance.show()};BX.CrmKanbanDragDrop.prototype.convertId=null;BX.CrmKanbanDragDrop.prototype.convertPopupInstance=null;BX.CrmKanbanDragDrop.prototype.convertPopup=function(t){BX.CrmKanbanDragDrop.prototype.convertId=t;if(this.convertPopupInstance===null){var e=[];for(var a in BX.CrmLeadConversionScheme.messages){e.push(BX.create("DIV",{attrs:{"data-type":a},text:BX.CrmLeadConversionScheme.messages[a],events:{click:BX.proxy(this.convertPopupClick,this)}}))}e.push(BX.create("DIV",{attrs:{"data-type":"SELECT"},text:BX.message("CRM_KANBAN_CONVERT_SELECT_ENTITY"),events:{click:BX.proxy(this.convertPopupClick,this)}}));this.convertPopupInstance=new BX.PopupWindow("kanban_convert",window.body,{className:"crm-kanban-popup-convert",offsetLeft:0,lightShadow:true,closeIcon:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,closeByEsc:true,contentColor:"white",content:BX.create("div",{attrs:{className:"crm-kanban-popup-convert-list"},children:e})});this.convertPopupInstance.setTitleBar(BX.message("CRM_KANBAN_CONVERT_POPUP_TITLE"))}this.convertPopupInstance.show()};BX.CrmKanbanDragDrop.prototype.convertPopupClick=function(){var t=BX.proxy_context.getAttribute("data-type");var e=this.convertId;if(t==="SELECT"){BX.CrmLeadConverter.getCurrent().openEntitySelector(function(t){BX.CrmLeadConverter.getCurrent().convert(e,t.config,"",t.data)})}else{BX.CrmLeadConverter.getCurrent().convert(e,BX.CrmLeadConversionScheme.createConfig(t),"")}this.convertPopupInstance.close()};BX.CrmKanbanDragDrop.prototype.onDragStop=function(t,e,a){this.kanban.container.style.overflow="auto";this.draggableItem.layout.container.classList.remove("crm-kanban-deal-item-block");var n=this.draggableItem.columnId;document.body.style.height="";document.body.style.overflow="";document.body.style.width="";if(this.draggableItem){if(this.droppableItem){this.droppableItem.layout.container.style=" ";this.droppableItem.layout.container.className="crm-kanban-deal-item";var i=this.kanban.getColumn(this.droppableItem.columnId);var o=this.droppableItem.columnId;this.kanban.moveItemToColum(this.draggableItem,i,this.droppableItem);this.droppableItem.layout.container.parentNode.classList.add("crm-kanban-items-blocked")}else if(this.droppableColumn){var o=this.droppableColumn.id;this.droppableColumn.layout.container.className="crm-kanban-grid-item";this.kanban.moveItemToColum(this.draggableItem,this.droppableColumn);this.droppableColumn.layout.items.classList.add("crm-kanban-items-blocked")}else if(this.droppableZone){var o=this.droppableZone.getAttribute("data-id");this.droppableZone.className="crm-kanban-dropzone-item";this.kanban.removeToColumnItem(this.draggableItem)}if(BX.CrmKanbanHelper.getInstance().getEntityType()==="INVOICE"&&(o==="P"||this.droppableZone)&&n!=o){this.invoicePopup(this.draggableItem.id,o,n)}else{BX.CrmKanbanHelper.getInstance().moveState(this.draggableItem.id,o,n)}if(BX.CrmKanbanHelper.getInstance().getEntityType()==="LEAD"&&o==="CONVERTED"&&n!=o){this.convertPopup(this.draggableItem.id)}}this.dropContainer.className="crm-kanban-dropzone";this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableColumn=null;this.droppableItem=null;this.droppableZone=null}}
//# sourceMappingURL=script.map.js
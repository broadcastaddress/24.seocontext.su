BX.namespace("BX.Crm.Automation");BX.Crm.Automation=function(t){"use strict";var e=function(e){if(!t.type.isDomNode(e))throw"baseNode must be Dom Node Element";this.node=e};e.ViewMode={View:1,Edit:2};e.LogStatus={Waiting:0,Running:1,Completed:2,AutoCompleted:3};e.idIncrement=0;e.generateUniqueId=function(){++e.idIncrement;return"crm-automation-cmp-"+e.idIncrement};e.prototype={init:function(i,a){var s=this;this.viewMode=a||e.ViewMode.View;if(typeof i==="undefined")i={};this.data=i;this.initData();this.initTracker();this.initTriggerManager();this.initTemplateManager();this.initButtons();this.initButtonsPosition();this.initHelpTips();this.setTitle();this.fixTitleColors();window.onbeforeunload=function(){if(s.templateManager.needSave()||s.triggerManager.needSave()){return t.message("CRM_AUTOMATION_CMP_NEED_SAVE")}};t.addCustomEvent("CrmProgressControlAfterSaveSucces",t.delegate(this.onStatusChange,this))},initData:function(){this.entityTypeId=this.data.ENTITY_TYPE_ID;this.entityId=this.data.ENTITY_ID;this.entityCategoryId=this.data.ENTITY_CATEGORY_ID;this.bizprocEditorUrl=this.data.BIZPROC_EDITOR_URL;this.entityStatuses=this.data.ENTITY_STATUSES;this.statusesSort=[];for(var t=0;t<this.entityStatuses.length;++t){this.statusesSort.push(this.entityStatuses[t]["STATUS_ID"])}this.setEntityStatus(this.data.ENTITY_STATUS)},setEntityStatus:function(t){this.entityStatus=t;this.currentStatusIndex=-1;for(var e=0;e<this.statusesSort.length;++e){if(this.statusesSort[e]==t){this.currentStatusIndex=e;break}}return this},isPreviousEntityStatus:function(t){var e=0;for(var i=0;i<this.statusesSort.length;++i){if(t==this.statusesSort[i])e=i}return this.currentStatusIndex>-1&&e<this.currentStatusIndex},isCurrentEntityStatus:function(t){return t==this.entityStatus},isNextEntityStatus:function(t){var e=0;for(var i=0;i<this.statusesSort.length;++i){if(t==this.statusesSort[i])e=i}return this.currentStatusIndex>-1&&e>this.currentStatusIndex},initTriggerManager:function(){this.triggerManager=new o(this);this.triggerManager.init(this.data,this.viewMode)},reInitTriggerManager:function(e){if(t.type.isArray(e))this.data.TRIGGERS=e;this.triggerManager.reInit(this.data,this.viewMode)},initTemplateManager:function(){this.templateManager=new i(this);this.templateManager.init(this.data,this.viewMode)},reInitTemplateManager:function(e){if(t.type.isArray(e))this.data.TEMPLATES=e;this.templateManager.reInit(this.data,this.viewMode)},initButtons:function(){var i=this.node.querySelector('[data-role="automation-buttons"]');if(i){if(this.viewMode===e.ViewMode.View){t.hide(i)}}this.bindSaveButton();this.bindCancelButton();this.bindChangeViewButton()},initButtonsPosition:function(){var e=this.node.querySelector('[data-role="automation-buttons"]');var i=t.create("span",{attrs:{className:"crm-lead-header-contact-btn crm-automation-pin-btn crm-lead-header-contact-btn-pin"},events:{click:function(){this.classList.toggle("crm-lead-header-contact-btn-unpin");e.classList.toggle("crm-automation-buttons-fixed")}}});if(e){e.appendChild(i)}},initHelpTips:function(){var t=this.node.querySelectorAll('[data-role="automation-help-tips"]');for(var e=0;e<t.length;++e){T.bindToNode(t[e])}},reInitButtons:function(){var i=this.node.querySelector('[data-role="automation-buttons"]');if(i&&this.viewMode===e.ViewMode.View){t.hide(i)}else if(i&&this.viewMode===e.ViewMode.Edit){t.show(i)}var a=this.node.querySelector('[data-role="automation-btn-change-view"]');if(a){a.innerHTML=a.getAttribute("data-label-"+(this.viewMode===e.ViewMode.View?"edit":"view"))}},setTitle:function(){var t=this.node.querySelector('[data-role="automation-title"]');if(t){t.innerHTML=t.getAttribute("data-title-"+(this.viewMode===e.ViewMode.View?"view":"edit"))}},fixTitleColors:function(){var t,e,i=this.node.querySelectorAll('[data-role="automation-status-title"]');for(t=0;t<i.length;++t){e=i[t].getAttribute("data-bgcolor");if(e){var a=parseInt(e,16);var s=a>>16&255;var o=a>>8&255;var n=a&255;var r=.21*s+.72*o+.07*n;if(r<145){i[t].style.color="white"}}}},initTracker:function(){this.tracker=new r(this);this.tracker.init(this.data.LOG)},bindSaveButton:function(){var e=this,i=this.node.querySelector('[data-role="automation-btn-save"]');if(i){t.bind(i,"click",function(i){e.saveAutomation();return t.PreventDefault(i)})}},bindCancelButton:function(){var i=this,a=this.node.querySelector('[data-role="automation-btn-cancel"]');if(a){t.bind(a,"click",function(a){i.changeViewMode(e.ViewMode.View,true);return t.PreventDefault(a)})}},bindChangeViewButton:function(){var i=this,a=this.node.querySelector('[data-role="automation-btn-change-view"]');if(a){a.innerHTML=a.getAttribute("data-label-"+(this.viewMode===e.ViewMode.View?"edit":"view"));t.bind(a,"click",function(a){var s=i.viewMode===e.ViewMode.Edit?e.ViewMode.View:e.ViewMode.Edit;i.changeViewMode(s);return t.PreventDefault(a)})}},getAjaxUrl:function(){return t.util.add_url_param(this.data.AJAX_URL,{site_id:t.message("SITE_ID"),sessid:t.bitrix_sessid()})},saveAutomation:function(i){var a=this,s={ajax_action:"save_automation",entity_type_id:this.entityTypeId,triggers:this.triggerManager.serialize(),templates:this.templateManager.serialize()};return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:s,onsuccess:function(t){if(t.SUCCESS){a.reInitTemplateManager(t.DATA.templates);a.reInitTriggerManager(t.DATA.triggers);a.changeViewMode(e.ViewMode.View);if(i){i(t.DATA)}}else alert(t.ERRORS[0])}})},changeViewMode:function(i,a){if(!a&&(this.templateManager.needSave()||this.triggerManager.needSave())){alert(t.message("CRM_AUTOMATION_CMP_NEED_SAVE"));return}if(i!==e.ViewMode.View&&i!==e.ViewMode.Edit)throw"Unknown view mode";this.viewMode=i;this.reInitTriggerManager();this.reInitTemplateManager();this.reInitButtons();this.setTitle()},canEdit:function(){return this.data["CAN_EDIT"]},onStatusChange:function(i,a){var s=this;if(a&&a.VALUE)this.setEntityStatus(a["VALUE"]);t.ajax({method:"POST",dataType:"json",url:s.getAjaxUrl(),data:{ajax_action:"get_log",entity_type_id:s.entityTypeId,entity_id:s.entityId},onsuccess:function(t){if(t.DATA&&t.DATA.LOG){s.tracker.reInit(t.DATA.LOG);if(s.viewMode===e.ViewMode.View){s.templateManager.reInit()}}}})},onGlobalHelpClick:function(e){if(this.data["B24_TARIF_ZONE"]=="en"){window.open("https://helpdesk.bitrix24.com/open/4781101/")}else if(this.data["B24_TARIF_ZONE"]=="de"){window.open("https://helpdesk.bitrix24.de/open/4781105/")}else if(t.Helper){t.Helper.show("redirect=detail&HD_ID=4781037")}return t.PreventDefault(e)}};var i=function(t){this.component=t};i.prototype={init:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.View;this.availableRobots=t.type.isArray(i.AVAILABLE_ROBOTS)?i.AVAILABLE_ROBOTS:[];this.availableRobotsMap={};for(var s=0;s<this.availableRobots.length;++s){this.availableRobotsMap[this.availableRobots[s]["CLASS"]]=this.availableRobots[s]}this.templatesData=t.type.isArray(i.TEMPLATES)?i.TEMPLATES:[];this.initTemplates()},reInit:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.View;if(t.type.isArray(i.TEMPLATES))this.templatesData=i.TEMPLATES;this.reInitTemplates(this.templatesData)},initTemplates:function(){this.templates=[];this.templatesMap={};for(var t=0;t<this.templatesData.length;++t){var e=new a(this);e.init(this.templatesData[t],this.viewMode);this.templates.push(e);this.templatesMap[e.getStatusId()]=e}},reInitTemplates:function(t){for(var e=0;e<this.templates.length;++e){if(t[e]){this.templates[e].reInit(t[e],this.viewMode)}}},getAvailableRobots:function(){return this.availableRobots},getRobotDescription:function(t){return this.availableRobotsMap[t]||null},serialize:function(){var t=[];for(var e=0;e<this.templates.length;++e){t.push(this.templates[e].serialize())}return t},getTemplateByColumnNode:function(t){var e=t.getAttribute("data-status-id");return this.getTemplateByStatusId(e)},getTemplateByStatusId:function(t){return this.templatesMap[t]||null},needSave:function(){var t=false;for(var e=0;e<this.templates.length;++e){if(this.templates[e].isModified()){t=true;break}}return t}};var a=function(t){this.manager=t;this.component=t.component;this.data={}};a.prototype={init:function(i,a){if(t.type.isPlainObject(i))this.data=i;this.viewMode=a||e.ViewMode.View;this.node=this.component.node.querySelector('[data-role="automation-template"][data-status-id="'+this.getStatusId()+'"]');this.listNode=this.node.querySelector('[data-role="robot-list"]');this.buttonsNode=this.node.querySelector('[data-role="buttons"]');this.initRobots();this.initButtons();this.modified=false;if(!this.isExternalModified()){jsDD.registerDest(this.node,10)}},reInit:function(e,i){t.cleanNode(this.listNode);t.cleanNode(this.buttonsNode);this.init(e,i)},initRobots:function(){this.robots=[];this.robotsMap={};if(t.type.isArray(this.data.ROBOTS)){for(var e=0;e<this.data.ROBOTS.length;++e){var i=new s(this);i.init(this.data.ROBOTS[e],this.viewMode);this.insertRobotNode(i.node);this.robots.push(i);this.robotsMap[i.getId()]=i}}},getStatusId:function(){return this.data.ENTITY_STATUS},getTemplateId:function(){var t=parseInt(this.data.TEMPLATE_ID);return!isNaN(t)?t:0},initButtons:function(){if(this.isExternalModified()){this.createExternalLocker()}else if(this.viewMode===e.ViewMode.Edit){if(!this.isExternalModified())this.createAddButton();if(this.getTemplateId()>0&&this.component.bizprocEditorUrl.length>0)this.createExternalEditTemplateButton()}if(this.viewMode===e.ViewMode.View&&this.component.canEdit()){this.createEditButton()}},createAddButton:function(){var e=this,i=t.create("a",{text:t.message("CRM_AUTOMATION_CMP_ADD"),props:{href:"#"},events:{click:function(i){e.onAddButtonClick(this);return t.PreventDefault(i)}},attrs:{className:"crm-automation-robot-btn-add"}});this.buttonsNode.appendChild(i)},createEditButton:function(){var i=this,a=t.create("div"),s=t.create("a",{text:t.message("CRM_AUTOMATION_CMP_AUTOMATION_EDIT"),props:{href:"#"},events:{click:function(a){i.manager.component.changeViewMode(e.ViewMode.Edit);return t.PreventDefault(a)}},attrs:{className:"crm-automation-robot-btn-set"}});this.buttonsNode.appendChild(s)},createExternalEditTemplateButton:function(){var e=this,i=t.create("div"),a=t.create("a",{text:t.message("CRM_AUTOMATION_CMP_EXTERNAL_EDIT"),props:{href:"#"},events:{click:function(i){e.onExternalEditTemplateButtonClick(this);return t.PreventDefault(i)}},attrs:{className:"crm-automation-robot-btn-set"}});this.buttonsNode.appendChild(a)},createExternalLocker:function(){var i=this,a=t.create("div",{attrs:{className:"crm-automation-robot-container"},children:[t.create("div",{attrs:{className:"crm-automation-robot-container-wrapper crm-automation-robot-container-wrapper-lock"},children:[t.create("div",{attrs:{className:"crm-automation-robot-deadline"}}),t.create("div",{attrs:{className:"crm-automation-robot-title"},text:t.message("CRM_AUTOMATION_CMP_EXTERNAL_EDIT_TEXT")})]})]});if(this.viewMode===e.ViewMode.Edit&&this.component.bizprocEditorUrl.length>0){var s=t.create("div",{attrs:{className:"crm-automation-robot-btn-settings"},text:t.message("CRM_AUTOMATION_CMP_EDIT")});t.bind(a,"click",function(e){i.onExternalEditTemplateButtonClick(this);return t.PreventDefault(e)});a.lastChild.appendChild(s);var o=t.create("SPAN",{attrs:{className:"crm-automation-robot-btn-delete"}});t.bind(o,"click",function(e){i.onUnsetExternalModifiedClick(this);return t.PreventDefault(e)});a.lastChild.appendChild(o)}this.listNode.appendChild(a)},onAddButtonClick:function(i){var a=this,s,o=[];var n,r=this.manager.getAvailableRobots();for(s=0;s<r.length;++s){if(r[s]["EXCLUDED"])continue;n=r[s].NAME;if(r[s]["ROBOT_SETTINGS"]&&r[s]["ROBOT_SETTINGS"]["TITLE"])n=r[s]["ROBOT_SETTINGS"]["TITLE"];var l=r[s]["ROBOT_SETTINGS"]&&r[s]["ROBOT_SETTINGS"]["IS_DEMO"];if(window.location.search.indexOf("disable_demo")>=0)l=false;if(l)n+=" "+t.message("CRM_AUTOMATION_CMP_IS_DEMO");o.push({text:n,robotData:r[s],isDemo:l,documentStatus:i.getAttribute("data-status-id"),className:l?"crm-automation-menu-item-disabled menu-popup-no-icon":"",onclick:function(e,i){if(!i.isDemo){this.popupWindow.close();a.addRobot(i.robotData,function(t){a.openRobotSettingsDialog(t)})}return t.PreventDefault(e)}})}var d=i.getAttribute("data-menu-id");if(!d){d=e.generateUniqueId();i.setAttribute("data-menu-id",d)}t.PopupMenu.show(d,i,o,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0}})},onExternalEditTemplateButtonClick:function(t){var e=this.getTemplateId();if(e>0)this.openBizprocEditor(e)},onUnsetExternalModifiedClick:function(t){this.data["IS_EXTERNAL_MODIFIED"]=false;this.data["UNSET_EXTERNAL_MODIFIED"]=true;this.reInit(null,this.viewMode)},openBizprocEditor:function(t){var e=this.manager.component.bizprocEditorUrl.replace("#ID#",t);window.location.href=e},addRobot:function(t,e){var i,a=new s(this);i=t["NAME"];if(t["ROBOT_SETTINGS"]&&t["ROBOT_SETTINGS"]["TITLE"])i=t["ROBOT_SETTINGS"]["TITLE"];a.init({Type:t["CLASS"],Properties:{Title:i}},this.viewMode);a.draft=true;if(e)e(a)},insertRobot:function(t,e){if(e){for(var i=0;i<this.robots.length;++i){if(this.robots[i]!==e)continue;this.robots.splice(i,0,t);break}}else{this.robots.push(t)}this.modified=true},deleteRobot:function(t,e){for(var i=0;i<this.robots.length;++i){if(this.robots[i]===t){this.robots.splice(i,1);break}}if(e)e(t);this.modified=true},insertRobotNode:function(t,e){if(e){this.listNode.insertBefore(t,e)}else{this.listNode.appendChild(t)}},openRobotSettingsDialog:function(e){if(c.getRobotSettingsDialog())return;var i=this,a="crm_automation_robot_dialog";var s=t.create("form",{props:{name:a},style:{"min-width":"540px"}});s.appendChild(i.renderDelaySettings(e));var o=t.create("div",{attrs:{className:"crm-automation-robot-help"},events:{click:t.delegate(this.component.onGlobalHelpClick,this.component)}});s.appendChild(o);c.setRobotSettingsDialog({template:this,entityTypeId:this.data.ENTITY_TYPE_ID,entityStatus:this.data.ENTITY_STATUS,context:{ENTITY_TYPE_ID:this.manager.component.entityTypeId,ENTITY_CATEGORY_ID:this.manager.component.entityCategoryId,TEMPLATE_STATUS:this.getStatusId()},robot:e,sendAjaxRequest:this.getRobotAjaxResponse,form:s});t.ajax({method:"POST",dataType:"html",url:this.manager.component.getAjaxUrl(),data:{ajax_action:"get_robot_dialog",entity_type_id:this.data.ENTITY_TYPE_ID,document_status:this.data.ENTITY_STATUS,context:{ENTITY_TYPE_ID:this.manager.component.entityTypeId,ENTITY_CATEGORY_ID:this.manager.component.entityCategoryId,TEMPLATE_STATUS:this.getStatusId()},robot:e.serialize(),form_name:a},onsuccess:function(a){if(a){var o=t.create("div",{html:a});s.appendChild(o)}i.showRobotSettingsPopup(e,s)}})},getRobotAjaxResponse:function(e,i){if(!t.type.isPlainObject(e))e={};e.ajax_action="get_robot_ajax_response";e.entity_type_id=this.entityTypeId;e.document_status=this.entityStatus;e.context=this.context;e.robot=this.robot.serialize();t.ajax({method:"POST",dataType:"json",url:this.template.manager.component.getAjaxUrl(),data:e,onsuccess:function(e){if(t.type.isFunction(i))i(e["DATA"])}})},showRobotSettingsPopup:function(i,a){t.addClass(this.component.node,"automation-base-blocked");this.initRobotSettingsControls(i,a);var s=this,o=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:i.getProperty("Title"),content:a,closeIcon:true,zIndex:9,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function(e){s.currentRobot=null;c.setRobotSettingsDialog(null);s.destroyRobotSettingsControls();e.destroy();t.removeClass(s.component.node,"automation-base-blocked")}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){s.saveRobotSettings(a,i,t.delegate(function(){this.popupWindow.close()},this))}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});s.currentRobot=i;c.getRobotSettingsDialog().popup=o;o.show()},initRobotSettingsControls:function(t,e){this.robotSettingsControls=[];var i,a=e.querySelectorAll('[data-role="user-selector"]');for(i=0;i<a.length;++i){this.robotSettingsControls.push(new l(this.manager.component,a[i]))}var s=e.querySelectorAll('[data-role="inline-selector-target"]');for(i=0;i<s.length;++i){this.robotSettingsControls.push(new d(this.manager.component,s[i]))}var o=e.querySelectorAll('[data-role="time-selector"]');for(i=0;i<o.length;++i){this.robotSettingsControls.push(new u(o[i]))}},destroyRobotSettingsControls:function(){if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].destroy))this.robotSettingsControls[e].destroy()}}this.robotSettingsControls=null},renderDelaySettings:function(i){var a=t.clone(i.getDelayInterval());var s=i.isExecuteAfterPrevious();var o=e.generateUniqueId();var n=t.create("input",{attrs:{className:"crm-automation-popup-select-input",type:"radio",id:"param-group-3-1"+o,name:"execute_after_previous",value:"0"}});var r=t.create("input",{attrs:{className:"crm-automation-popup-select-input",type:"radio",id:"param-group-3-2"+o,name:"execute_after_previous",value:"1"}});var l=t.create("input",{attrs:{type:"hidden",name:"delay_type",value:a.type}});var d=t.create("input",{attrs:{type:"hidden",name:"delay_value",value:a.value}});var u=t.create("input",{attrs:{type:"hidden",name:"delay_value_type",value:a.valueType}});var c=t.create("input",{attrs:{type:"hidden",name:"delay_basis",value:a.basis}});if(s)r.setAttribute("checked","checked");else n.setAttribute("checked","checked");var h=t.create("span",{attrs:{className:"crm-automation-popup-settings-link crm-automation-delay-interval-basis"}});var m=[];if(t.type.isArray(this.component.data["ENTITY_FIELDS"])){var g,f;for(g=0;g<this.component.data["ENTITY_FIELDS"].length;++g){f=this.component.data["ENTITY_FIELDS"][g];if(f["Type"]=="date"||f["Type"]=="datetime"||f["Type"]=="UF:date")m.push(f)}}var T=new p({labelNode:h,typeNode:l,valueNode:d,valueTypeNode:u,basisNode:c,basisFields:m});var v=t.create("div",{attrs:{className:"crm-automation-popup-settings"},children:[t.create("div",{attrs:{className:"crm-automation-popup-settings-block"},children:[t.create("span",{attrs:{className:"crm-automation-popup-settings-title"},text:t.message("CRM_AUTOMATION_CMP_TO_EXECUTE")+":"}),n,t.create("label",{attrs:{className:"crm-automation-popup-settings-link","for":"param-group-3-1"+o},text:t.message("CRM_AUTOMATION_CMP_AT_ONCE")}),r,t.create("label",{attrs:{className:"crm-automation-popup-settings-link","for":"param-group-3-2"+o},text:t.message("CRM_AUTOMATION_CMP_AFTER_PREVIOUS")})]}),t.create("div",{attrs:{className:"crm-automation-popup-settings-block"},children:[l,d,u,c,t.create("span",{attrs:{className:"crm-automation-popup-settings-title"},text:t.message("CRM_AUTOMATION_CMP_CHOOSE_TIME")+":"}),h]})]});T.init(a);return v},setDelaySettingsFromForm:function(t,e){var i=new h;if(t["delay_value"]!=0){i.setType(t["delay_type"]);i.setValue(t["delay_value"]);i.setValueType(t["delay_value_type"]);i.setBasis(t["delay_basis"])}var a=t["execute_after_previous"]&&t["execute_after_previous"]==="1";e.setDelayInterval(i);e.setExecuteAfterPrevious(a);return this},saveRobotSettings:function(e,i,a){var s=this,o=t.ajax.prepareForm(e);t.ajax({method:"POST",dataType:"json",url:this.manager.component.getAjaxUrl(),data:{ajax_action:"save_robot_settings",entity_type_id:this.data.ENTITY_TYPE_ID,robot:i.serialize(),form_data:o["data"]},onsuccess:function(t){if(t.SUCCESS){i.updateData(t.DATA.robot);s.setDelaySettingsFromForm(o["data"],i);if(i.draft){s.robots.push(i);s.insertRobotNode(i.node)}delete i.draft;i.reInit();s.modified=true;if(a){a(t.DATA)}}else alert(t.ERRORS[0])}})},serialize:function(){var t=this.data;t["ROBOTS"]=[];for(var e=0;e<this.robots.length;++e){t["ROBOTS"].push(this.robots[e].serialize())}return t},isExternalModified:function(){return this.data["IS_EXTERNAL_MODIFIED"]===true},getRobotById:function(t){return this.robotsMap[t]||null},isModified:function(){return this.modified}};var s=function(t){this.template=t;this.templateManager=t.manager;this.component=this.templateManager.component;this.tracker=t.manager.component.tracker};s.generateName=function(){return"A"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)};s.prototype={init:function(t,i){if(t)this.data=t;if(!this.data.Name){this.data.Name=s.generateName()}this.delay=new h(this.data.Delay);this.viewMode=i||e.ViewMode.View;this.node=this.createNode()},reInit:function(t,e){var i=this.node;this.node=this.createNode();if(i.parentNode)i.parentNode.replaceChild(this.node,i)},getProperty:function(t){return this.data.Properties[t]||null},getId:function(){return this.data.Name||null},getLogStatus:function(){var t=e.LogStatus.Waiting;var i=this.tracker.getRobotLog(this.getId());if(i){t=parseInt(i["STATUS"])}else if(this.data.DelayName){i=this.tracker.getRobotLog(this.data.DelayName);if(i&&parseInt(i["STATUS"])>e.LogStatus.Waiting)t=e.LogStatus.Running}return t},createNode:function(){var i=this,a=this.getLogStatus(),s;var o=this.getDescriptionSettings();var n="crm-automation-robot-container-wrapper";if(this.viewMode===e.ViewMode.Edit){n+=" crm-automation-robot-container-wrapper-draggable"}var r=t.message("CRM_AUTOMATION_CMP_TO");var l=t.create("a",{attrs:{className:"crm-automation-robot-settings-name"}});if(o["IS_AUTO"]){l.textContent=t.message("CRM_AUTOMATION_CMP_AUTOMATICALLY")}else if(t.type.isPlainObject(this.data.viewData)){var d=this.data.viewData.responsibleLabel.replace("{=Document:ASSIGNED_BY_ID}",t.message("CRM_AUTOMATION_CMP_RESPONSIBLE")).replace("author",t.message("CRM_AUTOMATION_CMP_RESPONSIBLE"));if(d.indexOf("{=Document")>=0&&t.type.isArray(this.component.data["ENTITY_FIELDS"])){var u,p;for(u=0;u<this.component.data["ENTITY_FIELDS"].length;++u){p=this.component.data["ENTITY_FIELDS"][u];d=d.replace(p["SystemExpression"],p["Name"])}}l.textContent=d;if(this.data.viewData.responsibleUrl){l.href=this.data.viewData.responsibleUrl}if(parseInt(this.data.viewData.responsibleId)>0){t.tooltip(this.data.viewData.responsibleId,l)}}var c=m(this.getDelayInterval(),t.message("CRM_AUTOMATION_CMP_AT_ONCE"),this.component.data["ENTITY_FIELDS"]);if(this.isExecuteAfterPrevious()){c=c!==t.message("CRM_AUTOMATION_CMP_AT_ONCE")?c+", ":"";c+=t.message("CRM_AUTOMATION_CMP_AFTER_PREVIOUS")}var h;if(this.viewMode===e.ViewMode.Edit){h=t.create("a",{attrs:{className:"crm-automation-robot-link",title:c},text:c})}else{h=t.create("span",{attrs:{className:"crm-automation-robot-text"},text:c})}if(this.viewMode===e.ViewMode.View){switch(a){case e.LogStatus.Running:if(this.component.isCurrentEntityStatus(this.template.getStatusId())){s=t.create("div",{attrs:{className:"crm-automation-robot-loader"}})}break;case e.LogStatus.Completed:case e.LogStatus.AutoCompleted:n+=" crm-automation-robot-container-wrapper-complete";break}}var g=t.create("div",{attrs:{className:"crm-automation-robot-container","data-role":"robot-container","data-type":"item-robot","data-id":this.getId()},children:[t.create("div",{attrs:{className:n},children:[t.create("div",{attrs:{className:"crm-automation-robot-deadline"},children:[h]}),t.create("div",{attrs:{className:"crm-automation-robot-title"},text:this.getProperty("Title")}),t.create("div",{attrs:{className:"crm-automation-robot-settings"},children:[t.create("div",{attrs:{className:"crm-automation-robot-settings-title"},text:r+":"}),l]}),s]})]});if(this.viewMode===e.ViewMode.Edit){this.registerItem(g);var f=t.create("SPAN",{attrs:{className:"crm-automation-robot-btn-delete"}});t.bind(f,"click",function(e){i.onDeleteButtonClick(this);return t.PreventDefault(e)});g.lastChild.appendChild(f);var T=t.create("div",{attrs:{className:"crm-automation-robot-btn-settings"},text:t.message("CRM_AUTOMATION_CMP_EDIT")});t.bind(g,"click",function(e){i.onSettingsButtonClick(this);return t.PreventDefault(e)});g.lastChild.appendChild(T)}return g},onDeleteButtonClick:function(e){t.remove(this.node);this.template.deleteRobot(this)},onSettingsButtonClick:function(t){this.template.openRobotSettingsDialog(this)},updateData:function(e){if(t.type.isPlainObject(e)){this.data=e}else throw"Invalid data"},serialize:function(){var e=t.clone(this.data);e.Delay=this.delay.serialize();return e},getDelayInterval:function(){return this.delay},setDelayInterval:function(t){this.delay=t;return this},setExecuteAfterPrevious:function(t){this.data.ExecuteAfterPrevious=t?1:0;return this},isExecuteAfterPrevious:function(){return this.data.ExecuteAfterPrevious===1},registerItem:function(e){e.onbxdragstart=t.proxy(this.dragStart,this);e.onbxdrag=t.proxy(this.dragMove,this);e.onbxdragstop=t.proxy(this.dragStop,this);e.onbxdraghover=t.proxy(this.dragOver,this);jsDD.registerObject(e);jsDD.registerDest(e,1)},dragStart:function(){this.draggableItem=t.proxy_context;this.draggableItem.className="crm-automation-robot-container";if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var e=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.className="crm-automation-robot-container crm-automation-robot-container-drag";this.stub.style.width=e+"px";document.body.appendChild(this.stub)}},dragMove:function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"},dragOver:function(t,e,i){if(this.droppableItem){this.droppableItem.className="crm-automation-robot-container"}if(this.droppableColumn){this.droppableColumn.className="crm-automation-robot-list"}var a=t.getAttribute("data-type");if(a==="item-robot"){this.droppableItem=t;this.droppableColumn=null}if(a==="column-robot"){this.droppableColumn=t.children[0];this.droppableItem=null}if(this.droppableItem){this.droppableItem.className="crm-automation-robot-container crm-automation-robot-container-pre"}if(this.droppableColumn){this.droppableColumn.className="crm-automation-robot-list crm-automation-robot-list-pre"}},dragStop:function(){var t,e;if(this.draggableItem){if(this.droppableItem){this.droppableItem.className="crm-automation-robot-container";t=this.templateManager.getTemplateByColumnNode(this.droppableItem.parentNode);if(t){e=t.getRobotById(this.droppableItem.getAttribute("data-id"));if(this!==e)this.moveTo(t,e)}}else if(this.droppableColumn){this.droppableColumn.className="crm-automation-robot-list";t=this.templateManager.getTemplateByColumnNode(this.droppableColumn);if(t){this.moveTo(t)}}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null},moveTo:function(e,i){t.remove(this.node);this.template.deleteRobot(this);this.template=e;this.template.insertRobot(this,i);this.node=this.createNode();this.template.insertRobotNode(this.node,i?i.node:null)},getDescriptionSettings:function(){var t={};var e=this.templateManager.getRobotDescription(this.data["Type"]);if(e&&e["ROBOT_SETTINGS"]){t=e["ROBOT_SETTINGS"]}return t}};var o=function(t){this.component=t};o.prototype={init:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.View;this.availableTriggers=t.type.isArray(i.AVAILABLE_TRIGGERS)?i.AVAILABLE_TRIGGERS:[];this.triggersData=t.type.isArray(i.TRIGGERS)?i.TRIGGERS:[];this.columnNodes=document.querySelectorAll('[data-type="column-trigger"]');this.listNodes=this.component.node.querySelectorAll('[data-role="trigger-list"]');this.buttonsNodes=this.component.node.querySelectorAll('[data-role="trigger-buttons"]');this.initButtons();this.initTriggers();this.modified=false;for(var s=0;s<this.columnNodes.length;s++){jsDD.registerDest(this.columnNodes[s],10)}},reInit:function(i,a){if(!t.type.isPlainObject(i))i={};var s;this.viewMode=a||e.ViewMode.View;for(s=0;s<this.listNodes.length;++s){t.cleanNode(this.listNodes[s])}for(s=0;s<this.buttonsNodes.length;++s){t.cleanNode(this.buttonsNodes[s])}this.triggersData=t.type.isArray(i.TRIGGERS)?i.TRIGGERS:[];this.initTriggers();this.initButtons();this.modified=false},initTriggers:function(){this.triggers=[];for(var t=0;t<this.triggersData.length;++t){var e=new n(this);e.init(this.triggersData[t],this.viewMode);this.triggers.push(e)}},initButtons:function(){if(this.viewMode===e.ViewMode.Edit){for(var t=0;t<this.buttonsNodes.length;++t){this.createAddButton(this.buttonsNodes[t])}}},createAddButton:function(e){var i=this,a=t.create("a",{text:t.message("CRM_AUTOMATION_CMP_ADD"),props:{href:"#"},events:{click:function(e){i.onAddButtonClick(this);return t.PreventDefault(e)}},attrs:{className:"crm-automation-btn-add","data-status-id":e.getAttribute("data-status-id")}});e.appendChild(a)},onAddButtonClick:function(i){var a=this,s,o=[];for(s=0;s<this.availableTriggers.length;++s){o.push({text:this.availableTriggers[s].NAME,triggerData:{ENTITY_STATUS:i.getAttribute("data-status-id"),CODE:this.availableTriggers[s].CODE},onclick:function(e,i){a.addTrigger(i.triggerData);this.popupWindow.close();return t.PreventDefault(e)}})}var n=i.getAttribute("data-menu-id");if(!n){n=e.generateUniqueId();i.setAttribute("data-menu-id",n)}t.PopupMenu.show(n,i,o,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0}})},addTrigger:function(t,e){var i=new n(this);i.init(t,this.viewMode);this.triggers.push(i);if(e)e(i);this.modified=true},deleteTrigger:function(t,e){if(t.getId()>0){t.markDeleted()}else{for(var i=0;i<this.triggers.length;++i){if(this.triggers[i]===t)this.triggers.splice(i,1)}}if(e)e(t);this.modified=true},insertTriggerNode:function(t,e){var i=this.component.node.querySelector('[data-role="trigger-list"][data-status-id="'+t+'"]');i.appendChild(e)},serialize:function(){var t=[];for(var e=0;e<this.triggers.length;++e){t.push(this.triggers[e].serialize())}return t},getTriggerName:function(t){for(var e=0;e<this.availableTriggers.length;++e){if(t==this.availableTriggers[e]["CODE"])return this.availableTriggers[e]["NAME"]}return t},needSave:function(){return this.modified},openTriggerSettingsDialog:function(i){var a=this,s="crm_automation_trigger_dialog";var o=t.create("form",{props:{name:s},style:{"min-width":"540px"}});var n=t.create("div",{attrs:{className:"crm-automation-robot-help"},events:{click:t.delegate(this.component.onGlobalHelpClick,this.component)}});o.appendChild(n);var r=this.getTriggerName(i.data["CODE"]);o.appendChild(t.create("span",{attrs:{className:"crm-automation-popup-settings-title crm-automation-popup-settings-title-autocomplete"},text:t.message("CRM_AUTOMATION_CMP_TRIGGER_NAME")+":"}));o.appendChild(t.create("div",{attrs:{className:"crm-automation-popup-settings"},children:[t.create("input",{attrs:{className:"crm-automation-popup-input",type:"text",name:"name",value:i.data["NAME"]||r}})]}));if(i.data["CODE"]=="WEBHOOK"){o.appendChild(t.create("span",{attrs:{className:"crm-automation-popup-settings-title crm-automation-popup-settings-title-autocomplete"},text:"URL:"}));var l=t.create("textarea",{attrs:{className:"crm-automation-popup-textarea",placeholder:"...",readonly:"readonly",name:"webhook_handler"},events:{click:function(t){this.select()}}});o.appendChild(t.create("div",{attrs:{className:"crm-automation-popup-settings"},children:[l]}));o.appendChild(t.create("span",{attrs:{className:"crm-automation-popup-settings-title crm-automation-popup-settings-title-autocomplete"},text:t.message("CRM_AUTOMATION_CMP_WEBHOOK_ID")}));t.ajax({method:"POST",dataType:"json",url:this.component.getAjaxUrl(),data:{ajax_action:"get_webhook_handler",entity_type_id:this.component.entityTypeId},onsuccess:function(t){if(t["DATA"]["HANDLER"]){l.value=window.location.protocol+"//"+window.location.host+t["DATA"]["HANDLER"]}}})}else if(i.data["CODE"]=="WEBFORM"){t.ajax({method:"POST",dataType:"json",url:this.component.getAjaxUrl(),data:{ajax_action:"get_webform_forms"},onsuccess:function(e){if(e["DATA"]["forms"]){var a=t.create("select",{attrs:{className:"crm-automation-popup-settings-dropdown"},props:{name:"form_id",
value:""},children:[t.create("option",{props:{value:""},text:t.message("CRM_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var s=0;s<e["DATA"]["forms"].length;++s){var n=e["DATA"]["forms"][s];a.appendChild(t.create("option",{props:{value:n["ID"]},text:n["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["form_id"]){a.value=i.data["APPLY_RULES"]["form_id"]}var r=t.create("div",{attrs:{className:"crm-automation-popup-settings"},children:[t.create("span",{attrs:{className:"crm-automation-popup-settings-title"},text:t.message("CRM_AUTOMATION_TRIGGER_WEBFORM_LABEL")+":"}),a]});o.appendChild(r)}}})}t.addClass(this.component.node,"automation-base-blocked");var d=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:r,content:o,closeIcon:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function(e){e.destroy();t.removeClass(a.component.node,"automation-base-blocked")}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){var e=t.ajax.prepareForm(o);i.data["NAME"]=e["data"]["name"];if(i.data["CODE"]=="WEBFORM"){i.data["APPLY_RULES"]={form_id:e["data"]["form_id"]}}i.reInit();a.modified=true;this.popupWindow.close()}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});d.show()}};var n=function(t){this.manager=t;this.component=t.component;this.tracker=t.component.tracker;this.data={};this.deleted=false;this.draggableItem=null;this.droppableItem=null;this.droppableColumn=null;this.stub=null;this.column=null};n.prototype={init:function(t,i){if(t)this.data=t;this.viewMode=i||e.ViewMode.View;this.node=this.createNode();this.manager.insertTriggerNode(this.getStatusId(),this.node)},reInit:function(t,e){var i=this.node;this.node=this.createNode();i.parentNode.replaceChild(this.node,i)},getId:function(){return this.data["ID"]||0},getStatusId:function(){return this.data["ENTITY_STATUS"]||""},getLogStatus:function(){var t=this.tracker.getTriggerLog(this.getId());return t?parseInt(t["STATUS"]):null},createNode:function(){var i=this,a=this.getLogStatus();var s="crm-automation-trigger-item-wrapper";if(this.viewMode===e.ViewMode.Edit){s+=" crm-automation-trigger-item-wrapper-draggable";var o=t.create("div",{attrs:{className:"crm-automation-trigger-item-wrapper-edit",style:"border-color: "+"#acf2fa"},text:t.message("CRM_AUTOMATION_CMP_EDIT")})}else{if(a==e.LogStatus.Completed){s+=" crm-automation-trigger-item-wrapper-complete"}else if(this.component.isPreviousEntityStatus(this.getStatusId())){s+=" crm-automation-trigger-item-wrapper-complete-light"}}var n=this.data["NAME"];if(!n){n=this.manager.getTriggerName(this.data["CODE"])}var r=t.create("DIV",{attrs:{"data-role":"trigger-container",className:"crm-automation-trigger-item","data-type":"item-trigger"},children:[t.create("div",{attrs:{className:s,style:"border-color: "+"#acf2fa"},children:[t.create("div",{attrs:{className:"crm-automation-trigger-item-wrapper-text"},text:n}),o]})]});if(this.viewMode===e.ViewMode.Edit){this.registerItem(r);var l=t.create("SPAN",{attrs:{"data-role":"btn-delete-trigger",className:"crm-automation-trigger-btn-delete"}});t.bind(l,"click",function(e){i.onDeleteButtonClick(this);return t.PreventDefault(e)});r.appendChild(l)}if(this.viewMode===e.ViewMode.Edit){t.bind(r,"click",function(e){i.onSettingsButtonClick(this);return t.PreventDefault(e)})}return r},onSettingsButtonClick:function(t){this.manager.openTriggerSettingsDialog(this)},registerItem:function(e){e.onbxdragstart=t.proxy(this.dragStart,this);e.onbxdrag=t.proxy(this.dragMove,this);e.onbxdragstop=t.proxy(this.dragStop,this);e.onbxdraghover=t.proxy(this.dragOver,this);jsDD.registerObject(e);jsDD.registerDest(e,1)},dragStart:function(){this.draggableItem=t.proxy_context;this.draggableItem.className="crm-automation-trigger-item";if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var e=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.className="crm-automation-trigger-item crm-automation-trigger-item-drag";this.stub.style.width=e+"px";document.body.appendChild(this.stub)}},dragMove:function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"},dragOver:function(t,e,i){if(this.droppableItem){this.droppableItem.className="crm-automation-trigger-item"}if(this.droppableColumn){this.droppableColumn.className="crm-automation-trigger-list"}var a=t.getAttribute("data-type");if(a==="item-trigger"){this.droppableItem=t;this.droppableColumn=null}if(a==="column-trigger"){this.droppableColumn=t.children[0];this.droppableItem=null}if(this.droppableItem){this.droppableItem.className="crm-automation-trigger-item crm-automation-trigger-item-pre"}if(this.droppableColumn){this.droppableColumn.className="crm-automation-trigger-list crm-automation-trigger-list-pre"}},dragStop:function(){if(this.draggableItem){if(this.droppableItem){this.droppableItem.className="crm-automation-trigger-item";var t=this.droppableItem.parentNode;t.insertBefore(this.draggableItem,this.droppableItem);this.moveTo(t.getAttribute("data-status-id"))}else if(this.droppableColumn){this.droppableColumn.className="crm-automation-trigger-list";this.droppableColumn.appendChild(this.draggableItem);this.moveTo(this.droppableColumn.getAttribute("data-status-id"))}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null},onDeleteButtonClick:function(e){t.remove(e.parentNode);this.manager.deleteTrigger(this)},updateData:function(e){if(t.type.isPlainObject(e)){this.data=e}else throw"Invalid data"},markDeleted:function(){this.deleted=true;return this},serialize:function(){var e=t.clone(this.data);if(this.deleted)e["DELETED"]="Y";return e},moveTo:function(t){this.data["ENTITY_STATUS"]=t;this.manager.modified=true}};var r=function(t){this.component=t};r.prototype={init:function(e){if(!t.type.isPlainObject(e))e={};this.log=e;this.triggers={};this.robots={};for(var i in e){if(!e.hasOwnProperty(i))continue;if(e[i]["trigger"]){this.triggers[e[i]["trigger"]["ID"]]=e[i]["trigger"]}if(e[i]["robots"]){for(var a in e[i]["robots"]){if(!e[i]["robots"].hasOwnProperty(a))continue;this.robots[a]=e[i]["robots"][a]}}}},reInit:function(t){this.init(t)},getRobotLog:function(t){return this.robots[t]||null},getTriggerLog:function(t){return this.triggers[t]||null}};var l=function(i,a){var s=this;var o,n=a.getAttribute("data-config");if(n){o=t.parseJSON(n)}if(!t.type.isPlainObject(o))o={};this.container=a;this.itemsNode=t.create("span");this.inputBoxNode=t.create("span",{attrs:{className:"feed-add-destination-input-box"}});this.inputNode=t.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=t.create("a",{attrs:{className:"feed-add-destination-link"}});t.addClass(a,"crm-automation-popup-autocomplete");a.appendChild(this.itemsNode);a.appendChild(this.inputBoxNode);a.appendChild(this.tagNode);this.component=i;this.itemTpl=o.itemTpl;this.data=null;this.dialogId=e.generateUniqueId();this.createValueNode(o.valueInputName||"");this.selected=o.selected?t.clone(o.selected):[];this.selectOne=!o.multiple;this.required=o.required||false;this.additionalFields=t.type.isArray(o.additionalFields)?o.additionalFields:[];t.bind(this.tagNode,"focus",function(e){s.openDialog({bByFocusEvent:true});return t.PreventDefault(e)});t.bind(this.container,"click",function(e){s.openDialog();return t.PreventDefault(e)});this.addItems(this.selected);this.tagNode.innerHTML=this.selected.length<=0?t.message("CRM_AUTOMATION_CMP_CHOOSE"):t.message("CRM_AUTOMATION_CMP_EDIT")};l.prototype={getData:function(e){var i=this;if(i.ajaxProgress)return;i.ajaxProgress=true;t.ajax({method:"POST",dataType:"json",url:i.component.getAjaxUrl(),data:{ajax_action:"get_destination_data",entity_type_id:i.component.entityTypeId},onsuccess:function(t){i.data=t.DATA||{};i.ajaxProgress=false;i.initDialog(e)}})},initDialog:function(e){var i,a=this,s=this.data;if(!s){a.getData(e);return}var o={};for(i=0;i<a.selected.length;++i){o[a.selected[i].id]=a.selected[i].entityType}var n={users:s.USERS||{},department:s.DEPARTMENT||{},departmentRelation:s.DEPARTMENT_RELATION||{},bpuserroles:s.ROLES||{}};var r={users:s.LAST.USERS||{},bpuserroles:s.LAST.ROLES||{}};for(i=0;i<this.additionalFields.length;++i){n.bpuserroles[this.additionalFields[i]["id"]]=this.additionalFields[i]}if(!n["departmentRelation"]){n["departmentRelation"]=t.SocNetLogDestination.buildDepartmentRelation(n["department"])}if(!a.inited){a.inited=true;var l=a.inputNode;l.id=a.dialogId+"input";var d=a.inputBoxNode;d.id=a.dialogId+"input-box";var u=this.tagNode;u.id=this.dialogId+"tag";var p=a.itemsNode;t.SocNetLogDestination.init({name:a.dialogId,searchInput:l,extranetUser:false,bindMainPopup:{node:a.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:a.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(e,i,s,o){a.addItem(e,i);if(a.selectOne)t.SocNetLogDestination.closeDialog()},unSelect:function(e){if(a.selectOne)return;a.unsetValue(e.entityId);t.SocNetLogDestination.BXfpUnSelectCallback.call({formName:a.dialogId,inputContainerName:p,inputName:l.id,tagInputName:u.id,tagLink1:t.message("CRM_AUTOMATION_CMP_CHOOSE"),tagLink2:t.message("CRM_AUTOMATION_CMP_EDIT")},e)},openDialog:t.delegate(t.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:d.id,inputName:l.id,tagInputName:u.id}),closeDialog:t.delegate(t.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:d.id,inputName:l.id,tagInputName:u.id}),openSearch:t.delegate(t.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:d.id,inputName:l.id,tagInputName:u.id}),closeSearch:t.delegate(t.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:d.id,inputName:l.id,tagInputName:u.id})},items:n,itemsLast:r,itemsSelected:o,useClientDatabase:false,destSort:s.DEST_SORT||{},allowAddUser:false});t.onCustomEvent(t.SocNetLogDestination,"onTabsAdd",[a.dialogId,{id:"bpuserrole",name:t.message("CRM_AUTOMATION_CMP_USER_SELECTOR_TAB"),itemType:"bpuserroles",dialogGroup:{groupCode:"bpuserroles",title:t.message("CRM_AUTOMATION_CMP_USER_SELECTOR_TAB")}}]);t.bind(l,"keyup",t.delegate(t.SocNetLogDestination.BXfpSearch,{formName:a.dialogId,inputName:l.id,tagInputName:u.id}));t.bind(l,"keydown",t.delegate(t.SocNetLogDestination.BXfpSearchBefore,{formName:a.dialogId,inputName:l.id}));t.SocNetLogDestination.BXfpSetLinkName({formName:a.dialogId,tagInputName:u.id,tagLink1:t.message("CRM_AUTOMATION_CMP_CHOOSE"),tagLink2:t.message("CRM_AUTOMATION_CMP_EDIT")})}e()},addItem:function(e,i){var a=this;var s=this.inputNode;var o=this.tagNode;var n=this.itemsNode;if(!t.findChild(n,{attr:{"data-id":e.id}},false,false)){if(a.selectOne&&a.inited){var r=[];for(var l=0;l<n.childNodes.length;++l){r.push({itemId:n.childNodes[l].getAttribute("data-id"),itemType:n.childNodes[l].getAttribute("data-type")})}a.initDialog(function(){for(var e=0;e<r.length;++e){t.SocNetLogDestination.deleteItem(r[e].itemId,r[e].itemType,a.dialogId)}});t.cleanNode(n);a.cleanValue()}var d=this.createItemNode({text:e.name,deleteEvents:{click:function(s){if(a.selectOne&&a.required){a.openDialog()}else{a.initDialog(function(){t.SocNetLogDestination.deleteItem(e.id,i,a.dialogId);t.remove(d);a.unsetValue(e.entityId)})}t.PreventDefault(s)}}});this.setValue(e.entityId);d.setAttribute("data-id",e.id);d.setAttribute("data-type",i);n.appendChild(d);if(!e.entityType)e.entityType=i}s.value="";o.innerHTML=t.message("CRM_AUTOMATION_CMP_EDIT")},addItems:function(t){for(var e=0;e<t.length;++e){this.addItem(t[e],t[e].entityType)}},openDialog:function(e){var i=this;this.initDialog(function(){t.SocNetLogDestination.openDialog(i.dialogId,e)})},destroy:function(){if(this.inited){if(t.SocNetLogDestination.isOpenDialog()){t.SocNetLogDestination.closeDialog()}t.SocNetLogDestination.closeSearch()}},createItemNode:function(e){return t.create("span",{attrs:{className:"crm-automation-popup-autocomplete-item"},children:[t.create("span",{attrs:{className:"crm-automation-popup-autocomplete-name"},html:e.text||""}),t.create("span",{attrs:{className:"crm-automation-popup-autocomplete-delete"},events:e.deleteEvents})]})},createValueNode:function(e){this.valueNode=t.create("input",{props:{type:"hidden",name:e}});this.container.appendChild(this.valueNode)},setValue:function(t){if(/^\d+$/.test(t))t="["+t+"]";if(this.selectOne)this.valueNode.value=t;else{var e,i=[],a=this.valueNode.value.split(";");for(e=0;e<a.length;++e){if(!a[e]||t==a[e])continue;i.push(a[e])}i.push(t);this.valueNode.value=i.join(";")}},unsetValue:function(t){if(/^\d+$/.test(t))t="["+t+"]";if(this.selectOne)this.valueNode.value="";else{var e,i=[],a=this.valueNode.value.split(";");for(e=0;e<a.length;++e){if(!a[e]||t==a[e])continue;i.push(a[e])}this.valueNode.value=i.join(";")}},cleanValue:function(){this.valueNode.value=""}};var d=function(e,i){var a=this;this.component=e;this.targetInput=t.clone(i);this.menuButton=t.create("span",{attrs:{className:"crm-automation-popup-select-dotted"},events:{click:t.delegate(a.openMenu,this)}});var s=t.create("div",{attrs:{className:"crm-automation-popup-select"},children:[this.targetInput,this.menuButton]});i.parentNode.replaceChild(s,i);t.bind(this.targetInput,"keydown",function(t){a.onKeyDown(this,t)});this.targetInput.setAttribute("autocomplete","off")};d.prototype={onKeyDown:function(e,i){if(i.keyCode==45&&i.altKey===false&&i.ctrlKey===false&&i.shiftKey===false){this.openMenu(i);t.PreventDefault(i)}},openMenu:function(i){var a=this,s,o=[];var n=this.component.data["ENTITY_FIELDS"];for(s=0;s<n.length;++s){o.push({text:n[s]["Name"],field:n[s],onclick:function(e,i){this.popupWindow.close();a.onFieldSelect(i.field);return t.PreventDefault(e)}})}var r=this.menuButton.getAttribute("data-selector-id");if(!r){r=e.generateUniqueId();this.menuButton.setAttribute("data-selector-id",r)}t.PopupMenu.show(r,this.menuButton,o,{zIndex:200,autoHide:true,offsetLeft:t.pos(this.menuButton)["width"]/2,angle:{position:"top",offset:0},className:"crm-automation-inline-selector-menu"});this.menu=t.PopupMenu.currentItem},onFieldSelect:function(t){var e=this.targetInput.value.substr(0,this.targetInput.selectionEnd),i="{{"+t["Name"]+"}}",a=this.targetInput.value.substr(this.targetInput.selectionEnd);this.targetInput.value=e+i+a;this.targetInput.selectionEnd=e.length+i.length},destroy:function(){if(this.menu)this.menu.popupWindow.close()}};var u=function(e){this.targetInput=e;var i=new Date,a=this.unFormatTime(e.value);i.setHours(0,0,0,0);i.setTime(i.getTime()+a*1e3);e.value=this.formatTime(i);t.bind(e,"click",t.delegate(this.showClock,this))};u.prototype={showClock:function(e){if(!this.clockInstance){this.clockInstance=new t.CClockSelector({start_time:this.unFormatTime(this.targetInput.value),node:this.targetInput,callback:t.delegate(this.onTimeSelect,this),zIndex:200})}this.clockInstance.Show()},onTimeSelect:function(e){this.targetInput.value=e;t.fireEvent(this.targetInput,"change");this.clockInstance.closeWnd()},unFormatTime:function(t){var e=t.split(/[\s:]+/);if(e.length==3){var i=e[2];if(i=="pm"&&e[0]<12)e[0]=parseInt(e[0],10)+12;if(i=="am"&&e[0]==12)e[0]=0}return parseInt(e[0],10)*3600+parseInt(e[1],10)*60},formatTime:function(e){var i=t.date.convertBitrixFormat(t.message("FORMAT_DATE")).replace(/:?\s*s/,""),a=t.date.convertBitrixFormat(t.message("FORMAT_DATETIME")).replace(/:?\s*s/,""),s=t.date.format(i,e),o=t.date.format(a,e);return t.util.trim(o.replace(s,""))},destroy:function(){if(this.clockInstance)this.clockInstance.closeWnd()}};var p=function(e){this.basisFields=[];if(t.type.isPlainObject(e)){this.labelNode=e.labelNode;this.typeNode=e.typeNode;this.basisNode=e.basisNode;this.valueNode=e.valueNode;this.valueTypeNode=e.valueTypeNode;if(t.type.isArray(e.basisFields))this.basisFields=e.basisFields}};p.prototype={init:function(t){this.delay=t;this.setLabelText();this.bindLabelNode();this.prepareBasisFields()},setLabelText:function(){if(this.delay&&this.labelNode){this.labelNode.textContent=m(this.delay,t.message("CRM_AUTOMATION_CMP_CHOOSE"),this.basisFields)}},bindLabelNode:function(){if(this.labelNode){t.bind(this.labelNode,"click",t.delegate(this.onLabelClick,this))}},onLabelClick:function(e){this.showDelayIntervalPopup();return t.PreventDefault(e)},showDelayIntervalPopup:function(){var i=this,a=this.delay;var s=e.generateUniqueId();var o=t.create("form",{attrs:{className:"crm-automation-popup-select-block"}});var n=t.create("input",{attrs:{className:"crm-automation-popup-select-input",id:s+"type1",type:"radio",value:h.Type.After,name:"type"}});if(a.type==h.Type.After)n.setAttribute("checked","checked");var r=t.create("label",{attrs:{className:"crm-automation-popup-select-wrapper","for":s+"type1"},html:'<span class="crm-automation-popup-settings-title">'+t.message("CRM_AUTOMATION_CMP_THROUGH")+"</span>"+'<input type="text" name="value_after" value="'+(a.type==h.Type.After?a.value:"0")+'" class="crm-automation-popup-settings-input">'+'<input type="radio" name="value_type_after" value="i" id="vt11'+s+'" class="crm-automation-popup-select-input"'+(a.valueType=="i"||a.type!=h.Type.After?" checked":"")+">"+'<label class="crm-automation-popup-settings-link" for="vt11'+s+'">'+t.message("CRM_AUTOMATION_CMP_INTERVAL_M")+"</label>"+'<input type="radio" name="value_type_after" value="h" id="vt12'+s+'" class="crm-automation-popup-select-input"'+(a.valueType=="h"&&a.type==h.Type.After?" checked":"")+">"+'<label class="crm-automation-popup-settings-link" for="vt12'+s+'">'+t.message("CRM_AUTOMATION_CMP_INTERVAL_H")+"</label>"+'<input type="radio" name="value_type_after" value="d" id="vt13'+s+'" class="crm-automation-popup-select-input"'+(a.valueType=="d"&&a.type==h.Type.After?" checked":"")+">"+'<label class="crm-automation-popup-settings-link" for="vt13'+s+'">'+t.message("CRM_AUTOMATION_CMP_INTERVAL_D")+"</label>"});var l=t.create("span",{attrs:{className:"crm-automation-status-help crm-automation-status-help-right","data-text":t.message("CRM_AUTOMATION_CMP_DELAY_AFTER_HELP")},text:"?"});T.bindToNode(l);r.appendChild(l);o.appendChild(t.create("div",{attrs:{className:"crm-automation-popup-select-item"},children:[n,r]}));if(this.basisFields.length>0){var d=t.create("input",{attrs:{className:"crm-automation-popup-select-input",id:s+"type2",type:"radio",value:h.Type.Before,name:"type"}});if(a.type==h.Type.Before)d.setAttribute("checked","checked");var u=t.create("label",{attrs:{className:"crm-automation-popup-select-wrapper","for":s+"type2"},html:'<span class="crm-automation-popup-settings-title">'+t.message("CRM_AUTOMATION_CMP_FOR_TIME")+"</span>"+'<input type="text" name="value_before" value="'+(a.type==h.Type.Before?a.value:"0")+'" class="crm-automation-popup-settings-input">'+'<input type="radio" name="value_type_before" value="i" id="vt21'+s+'" class="crm-automation-popup-select-input"'+(a.valueType=="i"||a.type==h.Type.After?" checked":"")+">"+'<label class="crm-automation-popup-settings-link" for="vt21'+s+'">'+t.message("CRM_AUTOMATION_CMP_INTERVAL_M")+"</label>"+'<input type="radio" name="value_type_before" value="h" id="vt22'+s+'" class="crm-automation-popup-select-input"'+(a.valueType=="h"&&a.type==h.Type.Before?" checked":"")+">"+'<label class="crm-automation-popup-settings-link" for="vt22'+s+'">'+t.message("CRM_AUTOMATION_CMP_INTERVAL_H")+"</label>"+'<input type="radio" name="value_type_before" value="d" id="vt23'+s+'" class="crm-automation-popup-select-input"'+(a.valueType=="d"&&a.type==h.Type.Before?" checked":"")+">"+'<label class="crm-automation-popup-settings-link" for="vt23'+s+'">'+t.message("CRM_AUTOMATION_CMP_INTERVAL_D")+"</label>"+'<span class="crm-automation-popup-settings-title">'+t.message("CRM_AUTOMATION_CMP_BEFORE_DATE")+"</span>"});var p=this.getBasisField(a.basis);var c=a.basis;if(!p){p=this.basisFields[0];c=p.SystemExpression}var m=t.create("input",{attrs:{type:"hidden",name:"basis_before",value:c}});var g=t.create("span",{attrs:{className:"crm-automation-popup-settings-link crm-automation-delay-interval-basis"},text:p?p.Name:t.message("CRM_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBeforeBasisClick(t,this,function(t){g.textContent=t.Name;m.value=t.SystemExpression})}}});u.appendChild(m);u.appendChild(g);var f=t.create("span",{attrs:{className:"crm-automation-status-help crm-automation-status-help-right","data-text":t.message("CRM_AUTOMATION_CMP_DELAY_BEFORE_HELP")},text:"?"});T.bindToNode(f);u.appendChild(f);o.appendChild(t.create("div",{attrs:{className:"crm-automation-popup-select-item"},children:[d,u]}))}var v=new t.PopupWindow("crm-automation-popup-set",this.labelNode,{autoHide:true,closeByEsc:true,closeIcon:false,titleBar:false,zIndex:0,angle:true,offsetLeft:45,content:o,buttons:[new t.PopupWindowButton({text:t.message("CRM_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create crm-automation-button-left",events:{click:function(){var e=t.ajax.prepareForm(o);i.delay.setType(e["data"]["type"]);i.delay.setValue(e["data"]["value_"+e["data"]["type"]]);i.delay.setValueType(e["data"]["value_type_"+e["data"]["type"]]);if(e["data"]["type"]==h.Type.After)i.delay.setBasis(h.Basis.CurrentDateTime);else i.delay.setBasis(e["data"]["basis_before"]);i.setLabelText();i.updateValueNodes();if(i.fieldsMenu)i.fieldsMenu.popupWindow.close();this.popupWindow.close()}}})],overlay:{backgroundColor:"transparent"}});v.show()},onBeforeBasisClick:function(i,a,s){var o=this,n,r=[];for(n=0;n<this.basisFields.length;++n){r.push({text:this.basisFields[n].Name,field:this.basisFields[n],onclick:function(e,i){if(s)s(i.field);this.popupWindow.close();return t.PreventDefault(e)}})}var l=a.getAttribute("data-menu-id");if(!l){l=e.generateUniqueId();a.setAttribute("data-menu-id",l)}t.PopupMenu.show(l,a,r,{zIndex:200,autoHide:true,offsetLeft:t.pos(a)["width"]/2,angle:{position:"top",offset:0}});this.fieldsMenu=t.PopupMenu.currentItem;return t.PreventDefault(i)},updateValueNodes:function(){if(this.delay){if(this.typeNode)this.typeNode.value=this.delay.type;if(this.valueNode)this.valueNode.value=this.delay.value;if(this.valueTypeNode)this.valueTypeNode.value=this.delay.valueType;if(this.basisNode)this.basisNode.value=this.delay.basis}},getBasisField:function(t){var e=null;for(var i=0;i<this.basisFields.length;++i){if(t==this.basisFields[i].SystemExpression)e=this.basisFields[i]}return e},prepareBasisFields:function(){var t,e,i=[];for(t=0;t<this.basisFields.length;++t){e=this.basisFields[t];if(e["Id"]!=="DATE_CREATE"&&e["Id"]!=="DATE_MODIFY"&&e["Id"]!=="EVENT_DATE"&&e["Id"]!=="BIRTHDATE")i.push(e)}this.basisFields=i}};var c={setRobotSettingsDialog:function(t){this.robotSettingsDialog=t},getRobotSettingsDialog:function(){return this.robotSettingsDialog}};var h=function(e){this.basis=h.Basis.CurrentDateTime;this.type=h.Type.After;this.value=0;this.valueType="i";if(t.type.isPlainObject(e)){if(e["type"])this.setType(e["type"]);if(e["value"])this.setValue(e["value"]);if(e["valueType"])this.setValueType(e["valueType"]);if(e["basis"])this.setBasis(e["basis"])}};h.Type={After:"after",Before:"before"};h.Basis={CurrentDate:"{=System:Date}",CurrentDateTime:"{=System:Now}"};h.prototype={setType:function(t){if(t!==h.Type.After&&t!==h.Type.Before)t=h.Type.After;this.type=t},setValue:function(t){t=parseInt(t);this.value=t>=0?t:0},setValueType:function(t){if(t!=="i"&&t!=="h"&&t!=="d")t="i";this.valueType=t},setBasis:function(e){if(t.type.isNotEmptyString(e))this.basis=e},serialize:function(){return{type:this.type,value:this.value,valueType:this.valueType,basis:this.basis}}};var m=function(e,i,a){var s=i;if(e.value){var o=e.type==h.Type.After?t.message("CRM_AUTOMATION_CMP_THROUGH"):t.message("CRM_AUTOMATION_CMP_FOR_TIME");s=o+" "+f(e.value,e.valueType);if(t.type.isArray(a)){for(var n=0;n<a.length;++n){if(e.basis==a[n].SystemExpression){s+=" "+t.message("CRM_AUTOMATION_CMP_BEFORE")+" "+a[n].Name;break}}}}return s};var g=function(e){var i=[];if(e==="i")i=[t.message("CRM_AUTOMATION_CMP_MIN1"),t.message("CRM_AUTOMATION_CMP_MIN2"),t.message("CRM_AUTOMATION_CMP_MIN3")];else if(e==="h")i=[t.message("CRM_AUTOMATION_CMP_HOUR1"),t.message("CRM_AUTOMATION_CMP_HOUR2"),t.message("CRM_AUTOMATION_CMP_HOUR3")];else if(e==="d")i=[t.message("CRM_AUTOMATION_CMP_DAY1"),t.message("CRM_AUTOMATION_CMP_DAY2"),t.message("CRM_AUTOMATION_CMP_DAY3")];return i};var f=function(t,e){var i=t+" ";var a=0;if(t>20)t=t%10;if(t==1)a=0;else if(t>1&&t<5)a=1;else a=2;var s=g(e);return i+(s?s[a]:"")};var T={popupHint:null,bindToNode:function(e){t.bind(e,"mouseover",t.proxy(function(){this.showHint(t.proxy_context)},this));t.bind(e,"mouseout",t.delegate(this.hideHint,this))},showHint:function(e){var i=e.getAttribute("data-text");if(!i)return;var a=t.util.htmlspecialchars(i);a=t.util.nl2br(a);if(!t.type.isNotEmptyString(a))return;this.popupHint=new t.PopupWindow("crm-automation-help-tip",e,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:1100,events:{onPopupClose:function(){this.destroy()}},content:t.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:a})});this.popupHint.setAngle({offset:32,position:"bottom"});this.popupHint.show();return true},hideHint:function(){if(this.popupHint)this.popupHint.close();this.popupHint=null}};return{Component:e,TriggerManager:o,TemplateManager:i,Template:a,Robot:s,Trigger:n,Tracker:r,Runtime:c}}(window.BX||window.top.BX);
//# sourceMappingURL=script.map.js
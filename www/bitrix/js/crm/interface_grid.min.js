if(typeof BX.CrmInterfaceGridManager=="undefined"){BX.CrmInterfaceGridManager=function(){this._id="";this._settings={};this._messages={};this._enableIterativeDeletion=false;this._toolbarMenu=null;this._applyButtonClickHandler=BX.delegate(this._handleFormApplyButtonClick,this);this._setFilterFieldsHandler=BX.delegate(this._onSetFilterFields,this);this._getFilterFieldsHandler=BX.delegate(this._onGetFilterFields,this);this._deletionProcessDialog=null};BX.CrmInterfaceGridManager.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._makeBindings();BX.ready(BX.delegate(this._bindOnGridReload,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuShow",BX.delegate(this._onToolbarMenuShow,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuClose",BX.delegate(this._onToolbarMenuClose,this));BX.addCustomEvent(window,"BXInterfaceGridCheckColumn",BX.delegate(this._onGridColumnCheck,this));this._messages=this.getSetting("messages",{});this._enableIterativeDeletion=!!this.getSetting("enableIterativeDeletion",false);if(this._enableIterativeDeletion){BX.addCustomEvent(window,"BXInterfaceGridDeleteRow",BX.delegate(this._onGridRowDelete,this))}},_onGridColumnCheck:function(e,t){if(this._toolbarMenu){t["columnMenu"]=this._toolbarMenu.GetMenuByItemId(t["targetElement"].id)}},_onGridRowDelete:function(e,t){var i=BX.type.isNotEmptyString(t["gridId"])?t["gridId"]:"";if(i===""||i!==this.getGridId()){return}t["cancel"]=true;BX.defer(BX.delegate(this.openDeletionDialog,this))({gridId:i,ids:t["selectedIds"],processAll:t["forAll"]})},_onToolbarMenuShow:function(e,t){this._toolbarMenu=t["menu"];t["items"]=this.getGridJsObject().settingsMenu},_onToolbarMenuClose:function(e,t){if(t["menu"]===this._toolbarMenu){this._toolbarMenu=null;this.getGridJsObject().SaveColumns()}},getId:function(){return this._id},reinitialize:function(){this._makeBindings();BX.onCustomEvent(window,"BXInterfaceGridManagerReinitialize",[this])},_makeBindings:function(){var e=this.getForm();if(e){BX.unbind(e["apply"],"click",this._applyButtonClickHandler);BX.bind(e["apply"],"click",this._applyButtonClickHandler)}BX.ready(BX.delegate(this._bindOnSetFilterFields,this))},_bindOnGridReload:function(){BX.addCustomEvent(window,"BXInterfaceGridAfterReload",BX.delegate(this._makeBindings,this))},_bindOnSetFilterFields:function(){var e=this.getGridJsObject();BX.removeCustomEvent(e,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.removeCustomEvent(e,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler);BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler)},registerFilter:function(e){BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",BX.delegate(this._onSetFilterFields,this));BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",BX.delegate(this._onGetFilterFields,this))},_onSetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=t.name.indexOf("flt_settings")===0;var a=n.length;var s=null;var o="";for(var d=0;d<a;d++){var l=n[d];var u=BX.type.isNotEmptyString(l["id"])?l["id"]:"";var c=BX.type.isNotEmptyString(l["typeName"])?l["typeName"].toUpperCase():"";var f=l["params"]?l["params"]:{};if(c==="USER"){var m=f["data"]?f["data"]:{};this._setElementByFilter(m[r?"settingsElementId":"elementId"],m["paramName"],i);var g=f["search"]?f["search"]:{};this._setElementByFilter(g[r?"settingsElementId":"elementId"],g["paramName"],i)}}},_setElementByFilter:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(t)&&i[t]?i[t]:""}},_onGetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=t.name.indexOf("flt_settings")===0;var a=n.length;for(var s=0;s<a;s++){var o=n[s];var d=BX.type.isNotEmptyString(o["id"])?o["id"]:"";var l=BX.type.isNotEmptyString(o["typeName"])?o["typeName"].toUpperCase():"";var u=o["params"]?o["params"]:{};if(l==="USER"){var c=u["data"]?u["data"]:{};this._setFilterByElement(c[r?"settingsElementId":"elementId"],c["paramName"],i);var f=u["search"]?u["search"]:{};this._setFilterByElement(f[r?"settingsElementId":"elementId"],f["paramName"],i)}}},_setFilterByElement:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)&&BX.type.isNotEmptyString(t)){i[t]=n.value}},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getMessage:function(e){return this._messages.hasOwnProperty(e)?this._messages[e]:e},getOwnerType:function(){return this.getSetting("ownerType","")},getForm:function(){return document.forms[this.getSetting("formName","")]},getGridId:function(){return this.getSetting("gridId","")},getGrid:function(){return BX(this.getSetting("gridId",""))},getGridJsObject:function(){var e=this.getSetting("gridId","");return BX.type.isNotEmptyString(e)?window["bxGrid_"+e]:null},getAllRowsCheckBox:function(){return BX(this.getSetting("allRowsCheckBoxId",""))},getEditor:function(){var e=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[e]?BX.CrmActivityEditor.items[e]:null},reload:function(){var e=this.getSetting("gridId");if(!BX.type.isNotEmptyString(e)){return false}var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.Reload)){return false}t.Reload();return true},getServiceUrl:function(){return this.getSetting("serviceUrl","/bitrix/components/bitrix/crm.activity.editor/ajax.php")},getListServiceUrl:function(){return this.getSetting("listServiceUrl","")},_loadCommunications:function(e,t,i){BX.ajax({url:this.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:e,ENTITY_TYPE:this.getOwnerType(),ENTITY_IDS:t,GRID_ID:this.getSetting("gridId","")},onsuccess:function(e){if(e&&e["DATA"]&&i){i(e["DATA"])}},onfailure:function(e){}})},_onEmailDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];for(var a=0;a<i.length;a++){var s=i[a];r.push({type:"EMAIL",entityTitle:"",entityType:n,entityId:s["entityId"],value:s["value"]})}}}this.addEmail(t)},_onCallDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];var a=i[0];r.push({type:"PHONE",entityTitle:"",entityType:n,entityId:a["entityId"],value:a["value"]});t["ownerType"]=n;t["ownerID"]=a["entityId"]}}this.addCall(t)},_onMeetingDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];var a=i[0];r.push({type:"",entityTitle:"",entityType:n,entityId:a["entityId"],value:a["value"]});t["ownerType"]=n;t["ownerID"]=a["entityId"]}}this.addMeeting(t)},_onDeletionProcessStateChange:function(e){if(e!==this._deletionProcessDialog||e.getState()!==BX.CrmLongRunningProcessState.completed){return}this._deletionProcessDialog.close();this.reload()},_handleFormApplyButtonClick:function(e){var t=this.getForm();if(!t){return true}var i=t.elements["action_button_"+this.getSetting("gridId","")];if(!i){return}var n=i.value;if(n==="subscribe"){var r=this.getAllRowsCheckBox();var a=[];if(!(r&&r.checked)){var s=BX.findChildren(this.getGrid(),{tagName:"INPUT",attribute:{type:"checkbox"}},true);if(s){for(var o=0;o<s.length;o++){var d=s[o];if(d.id.indexOf("ID")==0&&d.checked){a.push(d.value)}}}}this._loadCommunications("EMAIL",a,BX.delegate(this._onEmailDataLoaded,this));return BX.PreventDefault(e)}return true},openDeletionDialog:function(e){var t=BX.util.getRandomString(12);var i={CONTEXT_ID:t,GRID_ID:e["gridId"],ENTITY_TYPE_NAME:this.getOwnerType(),USER_FILTER_HASH:this.getSetting("userFilterHash","")};var n=e["processAll"];var r=e["ids"];if(n){i["PROCESS_ALL"]="Y"}else{i["ENTITY_IDS"]=r}this._deletionProcessDialog=BX.CrmLongRunningProcessDialog.create(t,{serviceUrl:this.getListServiceUrl(),action:"DELETE",params:i,title:this.getMessage("deletionDialogTitle"),summary:this.getMessage("deletionDialogSummary")});BX.addCustomEvent(this._deletionProcessDialog,"ON_STATE_CHANGE",BX.delegate(this._onDeletionProcessStateChange,this));this._deletionProcessDialog.show();this._deletionProcessDialog.start()},addEmail:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addEmail(e)},addCall:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.Planner!=="undefined"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE:e["ownerType"],OWNER_ID:e["ownerID"]});return}t.addCall(e)},addMeeting:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.Planner!=="undefined"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE:e["ownerType"],OWNER_ID:e["ownerID"]});return}t.addMeeting(e)},addTask:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addTask(e)},viewActivity:function(e,t){var i=this.getEditor();if(i){i.viewActivity(e,t)}}};BX.CrmInterfaceGridManager.items={};BX.CrmInterfaceGridManager.create=function(e,t){var i=new BX.CrmInterfaceGridManager;i.initialize(e,t);this.items[e]=i;BX.onCustomEvent(this,"CREATED",[i]);return i};BX.CrmInterfaceGridManager.addEmail=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addEmail(t)}};BX.CrmInterfaceGridManager.addCall=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addCall(t)}};BX.CrmInterfaceGridManager.addMeeting=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addMeeting(t)}};BX.CrmInterfaceGridManager.addTask=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addTask(t)}};BX.CrmInterfaceGridManager.viewActivity=function(e,t,i){if(typeof this.items[e]!=="undefined"){this.items[e].viewActivity(t,i)}};BX.CrmInterfaceGridManager.showPopup=function(e,t,i){BX.PopupMenu.show(e,t,i,{offsetTop:0,offsetLeft:-30})};BX.CrmInterfaceGridManager.reloadGrid=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.Reload)){return false}t.Reload();return true};BX.CrmInterfaceGridManager.applyFilter=function(e,t){var i=window["bxGrid_"+e];if(!i||!BX.type.isFunction(i.Reload)){return false}i.ApplyFilter(t);return true};BX.CrmInterfaceGridManager.clearFilter=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.ClearFilter)){return false}t.ClearFilter();return true};BX.CrmInterfaceGridManager.menus={};BX.CrmInterfaceGridManager.createMenu=function(e,t,i){i=parseInt(i);var n=new PopupMenu(e,!isNaN(i)?i:1010);if(BX.type.isArray(t)){n.settingsMenu=t}this.menus[e]=n};BX.CrmInterfaceGridManager.showMenu=function(e,t){var i=this.menus[e];if(typeof i!=="undefined"){i.ShowMenu(t,i.settingsMenu,false,false)}};BX.CrmInterfaceGridManager.expandEllipsis=function(e){if(!BX.type.isDomNode(e)){return false}var t=BX.findNextSibling(e,{"class":"bx-crm-text-cut-on"});if(t){BX.removeClass(t,"bx-crm-text-cut-on");BX.addClass(t,"bx-crm-text-cut-off");t.style.display=""}e.style.display="none";return true}}if(typeof BX.CrmUIGridExtension=="undefined"){BX.CrmUIGridExtension=function(){this._id="";this._settings={}};BX.CrmUIGridExtension.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{}},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getOwnerTypeName:function(){return this.getSetting("ownerTypeName","")},getActivityEditor:function(){var e=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[e]?BX.CrmActivityEditor.items[e]:null},createActivity:function(e,t){BX.namespace("BX.Crm.Activity");e=parseInt(e);if(isNaN(e)){e=BX.CrmActivityType.undefined}t=t?t:{};if(BX.type.isNumber(t["ownerID"])){t["ownerType"]=this.getOwnerTypeName()}if(e===BX.CrmActivityType.call||e===BX.CrmActivityType.meeting){if(typeof BX.Crm.Activity.Planner!=="undefined"){var i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:e,OWNER_TYPE:t["ownerType"],OWNER_ID:t["ownerID"]})}}else{var n=this.getActivityEditor();if(n){if(e===BX.CrmActivityType.email){n.addEmail(t)}else if(e===BX.CrmActivityType.task){n.addTask(t)}}}},viewActivity:function(e,t){var i=this.getActivityEditor();if(i){i.viewActivity(e,t)}}};BX.CrmUIGridExtension.createActivity=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].createActivity(t,i)}};BX.CrmUIGridExtension.viewActivity=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].viewActivity(t,i)}};BX.CrmUIGridExtension.contextMenus={};BX.CrmUIGridExtension.createContextMenu=function(e,t,i){i=parseInt(i);var n=new PopupMenu(e,!isNaN(i)?i:1010);if(BX.type.isArray(t)){n.settingsMenu=t}this.contextMenus[e]=n};BX.CrmUIGridExtension.showContextMenu=function(e,t){if(this.contextMenus.hasOwnProperty(e)){var i=this.contextMenus[e];i.ShowMenu(t,i.settingsMenu,false,false)}};BX.CrmUIGridExtension.items={};BX.CrmUIGridExtension.create=function(e,t){var i=new BX.CrmUIGridExtension;i.initialize(e,t);this.items[e]=i;return i}}
//# sourceMappingURL=interface_grid.map.js